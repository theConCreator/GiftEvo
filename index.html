<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plinko Chaos Edition</title>
    <style>
        body {
            margin: 0;
            background: #1a1a2e;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
        }

        canvas {
            background: #16213e;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            border-radius: 10px;
            cursor: crosshair;
        }

        .controls {
            margin: 20px;
            display: flex;
            gap: 15px;
            background: #0f3460;
            padding: 15px;
            border-radius: 10px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }

        .btn-normal { background: #e94560; color: white; }
        .btn-heavy { background: #533483; color: white; }
        .btn-gold { background: #f9d423; color: #333; }
        
        button:hover { transform: scale(1.05); opacity: 0.9; }

        .stats {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 24px;
        }

        .hint {
            color: #888;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <div class="stats">Счёт: <span id="score">0</span></div>

    <div class="controls">
        <button class="btn-normal" onclick="spawnBall('normal')">Обычный (x1)</button>
        <button class="btn-heavy" onclick="spawnBall('heavy')">Тяжелый (x2)</button>
        <button class="btn-gold" onclick="spawnBall('gold')">Золотой (x5)</button>
    </div>
    
    <div class="hint">Зажми левую кнопку мыши, чтобы активировать МАГНИТ!</div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreElement = document.getElementById('score');

        canvas.width = 600;
        canvas.height = 700;

        let score = 0;
        let balls = [];
        let pins = [];
        let portals = [];
        let movingPlats = [];
        let isMouseDown = false;
        let mousePos = { x: 0, y: 0 };

        const gravity = 0.2;
        const friction = 0.98;

        // Инициализация препятствий
        function initBoard() {
            // Обычные гвоздики (сетка)
            for (let row = 2; row < 10; row++) {
                let cols = row + 3;
                let spacing = canvas.width / (cols + 1);
                for (let col = 1; col <= cols; col++) {
                    pins.push({
                        x: col * spacing + (row % 2 * 10),
                        y: row * 60,
                        r: 5
                    });
                }
            }

            // Порталы
            portals.push({ x: 100, y: 350, targetX: 500, targetY: 200, color: '#00d2ff' });
            portals.push({ x: 500, y: 350, targetX: 100, targetY: 200, color: '#00d2ff' });

            // Движущиеся платформы
            movingPlats.push({ x: 300, y: 450, w: 100, dir: 1, speed: 2 });
        }

        function spawnBall(type) {
            let config = {
                normal: { r: 8, color: '#e94560', weight: 1, multiplier: 1 },
                heavy: { r: 12, color: '#533483', weight: 2, multiplier: 2 },
                gold: { r: 10, color: '#f9d423', weight: 1.2, multiplier: 5 }
            };
            
            let c = config[type];
            balls.push({
                x: canvas.width / 2 + (Math.random() * 40 - 20),
                y: 20,
                vx: (Math.random() - 0.5) * 4,
                vy: 0,
                ...c
            });
        }

        // Обработка мыши (магнит)
        canvas.onmousedown = () => isMouseDown = true;
        window.onmouseup = () => isMouseDown = false;
        canvas.onmousemove = (e) => {
            const rect = canvas.getBoundingClientRect();
            mousePos.x = e.clientX - rect.left;
            mousePos.y = e.clientY - rect.top;
        };

        function update() {
            // Движение платформ
            movingPlats.forEach(p => {
                p.x += p.dir * p.speed;
                if (p.x < 50 || p.x > canvas.width - 150) p.dir *= -1;
            });

            balls.forEach((ball, index) => {
                // Магнитная сила
                if (isMouseDown) {
                    let dx = mousePos.x - ball.x;
                    let dy = mousePos.y - ball.y;
                    let dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < 200) {
                        ball.vx += dx * 0.005;
                        ball.vy += dy * 0.005;
                    }
                }

                ball.vy += gravity * ball.weight;
                ball.vx *= friction;
                ball.x += ball.vx;
                ball.y += ball.vy;

                // Стенки
                if (ball.x < ball.r || ball.x > canvas.width - ball.r) ball.vx *= -0.6;

                // Столкновение с гвоздиками
                pins.forEach(pin => {
                    let dx = ball.x - pin.x;
                    let dy = ball.y - pin.y;
                    let dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < ball.r + pin.r) {
                        let angle = Math.atan2(dy, dx);
                        let speed = Math.sqrt(ball.vx**2 + ball.vy**2);
                        ball.vx = Math.cos(angle) * speed * 0.7;
                        ball.vy = Math.sin(angle) * speed * 0.7;
                        ball.y += ball.vy; // Выталкивание
                    }
                });

                // Порталы
                portals.forEach(p => {
                    let dist = Math.sqrt((ball.x - p.x)**2 + (ball.y - p.y)**2);
                    if (dist < 20) {
                        ball.x = p.targetX;
                        ball.y = p.targetY;
                    }
                });

                // Движущиеся платформы
                movingPlats.forEach(p => {
                    if (ball.x > p.x && ball.x < p.x + p.w && ball.y > p.y && ball.y < p.y + 10) {
                        ball.vy *= -0.8;
                        ball.vx += p.dir * p.speed;
                    }
                });

                // Финиш (лунки)
                if (ball.y > canvas.height - 30) {
                    let zone = Math.floor(ball.x / (canvas.width / 5));
                    let multipliers = [10, 50, 100, 50, 10];
                    score += multipliers[zone] * ball.multiplier;
                    scoreElement.innerText = score;
                    balls.splice(index, 1);
                }
            });
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Отрисовка порталов
            portals.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 20, 0, Math.PI * 2);
                ctx.strokeStyle = p.color;
                ctx.lineWidth = 3;
                ctx.stroke();
                ctx.fillStyle = 'rgba(0, 210, 255, 0.2)';
                ctx.fill();
            });

            // Отрисовка гвоздиков
            ctx.fillStyle = "#fff";
            pins.forEach(pin => {
                ctx.beginPath();
                ctx.arc(pin.x, pin.y, pin.r, 0, Math.PI * 2);
                ctx.fill();
            });

            // Платформы
            ctx.fillStyle = "#4ecdc4";
            movingPlats.forEach(p => {
                ctx.fillRect(p.x, p.y, p.w, 10);
            });

            // Шары
            balls.forEach(ball => {
                ctx.beginPath();
                ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2);
                ctx.fillStyle = ball.color;
                ctx.fill();
                ctx.closePath();
            });

            // Лунки
            for (let i = 0; i < 5; i++) {
                ctx.fillStyle = i % 2 === 0 ? "#1f4068" : "#16213e";
                ctx.fillRect(i * (canvas.width / 5), canvas.height - 50, canvas.width / 5, 50);
                ctx.fillStyle = "white";
                ctx.fillText(["10", "50", "100", "50", "10"][i], i * (canvas.width / 5) + 50, canvas.height - 20);
            }

            // Эффект магнита
            if (isMouseDown) {
                ctx.beginPath();
                ctx.arc(mousePos.x, mousePos.y, 100, 0, Math.PI*2);
                ctx.strokeStyle = "rgba(255, 255, 255, 0.1)";
                ctx.stroke();
            }

            update();
            requestAnimationFrame(draw);
        }

        initBoard();
        draw();
    </script>
</body>
</html>