<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Orbit Pro: Vibrant Fixed</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <style>
        :root { 
            --bg: #080812; 
            --accent: #00ffa3; 
            --gold: #ffde59;
            --panel: rgba(255, 255, 255, 0.08);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background: var(--bg); color: white; overflow: hidden; height: 100vh; width: 100vw; }

        canvas { position: absolute; inset: 0; z-index: 1; }
        
        /* Контейнер ракеты (Lottie) */
        #rocket-node { 
            position: absolute; width: 60px; height: 60px; z-index: 10; 
            pointer-events: none; display: flex; align-items: center; justify-content: center;
        }
        /* Запасная ракета, если Lottie не загрузится */
        .fallback-rocket {
            width: 0; height: 0; 
            border-left: 15px solid transparent; border-right: 15px solid transparent;
            border-bottom: 40px solid var(--accent);
            filter: drop-shadow(0 0 10px var(--accent));
        }

        /* HEADER UI - Фикс наслоения */
        #header { 
            position: absolute; top: 0; left: 0; width: 100%; 
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px; z-index: 100; pointer-events: none;
        }
        .header-item { pointer-events: auto; background: var(--panel); backdrop-filter: blur(15px); border-radius: 12px; padding: 10px 15px; border: 1px solid rgba(255,255,255,0.1); }
        
        .bank-info { display: flex; flex-direction: column; min-width: 100px; }
        .balance-val { color: var(--accent); font-weight: 900; font-size: 18px; }
        .bonus-val { color: var(--gold); font-size: 11px; font-weight: bold; text-transform: uppercase; }

        .history-list { display: flex; gap: 6px; overflow: hidden; justify-content: center; flex-grow: 1; margin: 0 20px; }
        .h-chip { padding: 5px 12px; border-radius: 8px; background: rgba(0,0,0,0.4); font-size: 12px; font-weight: 900; color: var(--accent); border: 1px solid rgba(0,255,163,0.2); }

        .btn-cam { cursor: pointer; font-size: 11px; font-weight: 900; letter-spacing: 1px; text-align: center; min-width: 90px; }
        .btn-cam.active { background: var(--accent); color: #000; box-shadow: 0 0 15px var(--accent); }

        /* Таймер */
        #timer-center { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; z-index: 50; }
        #count-num { font-size: 120px; font-weight: 900; color: white; line-height: 1; filter: drop-shadow(0 0 20px rgba(0,255,163,0.5)); }

        /* Управление ставкой */
        .bottom-panel { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); width: 340px; z-index: 100; transition: 0.5s cubic-bezier(0.17, 0.84, 0.44, 1); }
        .bottom-panel.hide { opacity: 0; transform: translate(-50%, 120px); pointer-events: none; }
        .bet-card { background: #121225; padding: 25px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); pointer-events: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        
        input { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 15px; border-radius: 14px; margin-bottom: 15px; text-align: center; font-size: 22px; font-weight: bold; outline: none; }
        .btn-main { width: 100%; background: var(--accent); color: #000; border: none; padding: 20px; border-radius: 14px; font-weight: 900; text-transform: uppercase; cursor: pointer; transition: 0.2s; }
        .btn-main:active { transform: scale(0.95); }

        /* Экран результата */
        #result-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(20px); }
        .res-box { text-align: center; animation: pop 0.4s cubic-bezier(0.17, 0.89, 0.32, 1.2); }
        .res-mult { font-size: 110px; font-weight: 900; color: var(--accent); margin: 10px 0; text-shadow: 0 0 30px var(--accent); }
        @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body>

<div id="rocket-node"><div class="fallback-rocket"></div></div>
<canvas id="gameCanvas"></canvas>

<div id="header">
    <div class="header-item bank-info">
        <div class="balance-val">$<span id="bank-val">1000</span></div>
        <div class="bonus-val" id="bonus-tag">BONUS x0.0</div>
    </div>
    <div class="history-list" id="hist-list"></div>
    <div class="header-item btn-cam" id="camToggle">FOLLOW</div>
</div>

<div id="timer-center">
    <div id="count-num">5.0</div>
</div>

<div class="bottom-panel" id="betControl">
    <div class="bet-card">
        <input type="number" id="betInput" value="100">
        <button class="btn-main" id="launchBtn">LAUNCH ROCKET</button>
    </div>
</div>

<div id="result-screen">
    <div class="res-box">
        <div style="letter-spacing: 5px; opacity: 0.5; font-weight: bold;">MISSION OVER</div>
        <div class="res-mult" id="res-mult">x2.5</div>
        <button class="btn-main" onclick="location.reload()" style="padding: 15px 50px; width: auto;">RETRY</button>
    </div>
</div>

<script>
/** ENGINE CONFIG **/
const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
const rocketNode = document.getElementById('rocket-node');

const SYSTEM_RADIUS = 25000; 
let state = 'IDLE', timer = 5.0, balance = 1000, currentBet = 0, bonusMult = 0;
let cam = { x: 0, y: 0, z: 0.04, tz: 0.04, mode: 'follow' };
let rocket = { x: 0, y: 0, vx: 0, vy: 0, rot: 0, aimAngle: 0 };
let world = { planets: [], stars: [], golds: [] };
let history = [1.5, 0.0, 4.2];

function init() {
    window.addEventListener('resize', resize); 
    resize();
    generateWorld();
    updateHistoryUI();

    // Пытаемся загрузить Lottie
    try {
        lottie.loadAnimation({
            container: rocketNode,
            renderer: 'svg',
            loop: true,
            autoplay: true,
            path: 'rocket1.json' // Если файла нет, останется fallback-rocket
        }).addEventListener('DOMLoaded', () => {
            document.querySelector('.fallback-rocket').style.display = 'none';
        });
    } catch(e) {}

    // Кнопки
    document.getElementById('launchBtn').addEventListener('click', () => {
        if(state === 'IDLE') {
            currentBet = parseInt(document.getElementById('betInput').value) || 100;
            if(balance >= currentBet) {
                balance -= currentBet;
                document.getElementById('bank-val').innerText = balance;
                document.getElementById('launchBtn').disabled = true;
                document.getElementById('launchBtn').style.background = "#1a3a4a";
                document.getElementById('launchBtn').innerText = "SYSTEMS ONLINE";
            }
        }
    });

    document.getElementById('camToggle').addEventListener('click', () => {
        cam.mode = cam.mode === 'follow' ? 'world' : 'follow';
        document.getElementById('camToggle').classList.toggle('active');
        document.getElementById('camToggle').innerText = cam.mode.toUpperCase();
    });

    requestAnimationFrame(loop);
}

function generateWorld() {
    world.stars = Array.from({length: 500}, () => ({ 
        x: Math.random()*100000-50000, y: Math.random()*100000-50000, s: Math.random()*3 
    }));
    
    const colors = ['#FF4757', '#2ED573', '#1E90FF', '#FFA502', '#70A1FF', '#FF6348'];
    for(let i=0; i<6; i++) {
        world.planets.push({
            dist: 5000 + i*4000, ang: Math.random()*Math.PI*2, speed: 0.0004 + i*0.0001,
            r: 1000 + Math.random()*1200, 
            color: colors[i],
            mult: (1.2 + (i * 3.5)).toFixed(1),
            x: 0, y: 0
        });
    }
    world.golds = Array.from({length: 30}, () => ({ 
        x: Math.random()*40000-20000, y: Math.random()*40000-20000, r: 200, active: true 
    }));
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

function update() {
    // Планеты всегда в движении
    world.planets.forEach(p => {
        p.ang += p.speed; 
        p.x = Math.cos(p.ang)*p.dist; 
        p.y = Math.sin(p.ang)*p.dist;
    });

    if(state === 'IDLE') {
        timer -= 1/60;
        document.getElementById('count-num').innerText = Math.max(0, timer).toFixed(1);
        
        // Новое прицеливание: плавное качание
        rocket.aimAngle = Math.sin(Date.now()*0.003) * 70; 
        rocket.rot = rocket.aimAngle;
        
        if(timer <= 0) startFlight();
    } 
    else if(state === 'FLYING') {
        // Быстрый полет + Гравитация
        world.planets.forEach(p => {
            const dx = p.x - rocket.x, dy = p.y - rocket.y, d = Math.hypot(dx, dy);
            if(d < p.r * 2.5) {
                rocket.vx += (dx/d)*7; rocket.vy += (dy/d)*7; 
                if(d < p.r + 100) finishRound('WIN', p.mult);
            }
        });

        // Сбор золота
        world.golds.forEach(g => {
            if(g.active && Math.hypot(g.x-rocket.x, g.y-rocket.y) < 600) {
                g.active = false; bonusMult += 0.2;
                document.getElementById('bonus-tag').innerText = `BONUS x${bonusMult.toFixed(1)}`;
            }
        });

        rocket.x += rocket.vx; rocket.y += rocket.vy;
        rocket.rot = Math.atan2(rocket.vy, rocket.vx)*180/Math.PI;

        // Вылет за границы
        if(Math.hypot(rocket.x, rocket.y) > SYSTEM_RADIUS + 5000) finishRound('LOST', 0);
    }

    // КАМЕРА
    if(cam.mode === 'follow') {
        cam.x += (rocket.x - cam.x) * 0.1; 
        cam.y += (rocket.y - cam.y) * 0.1;
        cam.tz = 0.04 / (1 + Math.hypot(rocket.vx, rocket.vy)*0.01);
    } else {
        cam.x *= 0.1; cam.y *= 0.1;
        const zoomBase = Math.min(canvas.width, canvas.height) / (SYSTEM_RADIUS * 2.2);
        cam.tz = zoomBase;
    }
    cam.z += (cam.tz - cam.z) * 0.05;

    // Синхронизация DOM-узла ракеты
    const sx = (rocket.x - cam.x)*cam.z + canvas.width/2;
    const sy = (rocket.y - cam.y)*cam.z + canvas.height/2;
    rocketNode.style.left = sx-30+'px'; 
    rocketNode.style.top = sy-30+'px';
    rocketNode.style.transform = `scale(${cam.z*35})`;
    rocketNode.style.rotate = (rocket.rot + 45) + 'deg';
}

function draw() {
    ctx.fillStyle = '#080812'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.save();
    ctx.translate(canvas.width/2, canvas.height/2); 
    ctx.scale(cam.z, cam.z); 
    ctx.translate(-cam.x, -cam.y);

    // Stars
    ctx.fillStyle = "rgba(255,255,255,0.8)";
    world.stars.forEach(s => ctx.fillRect(s.x, s.y, s.s/cam.z, s.s/cam.z));

    // Gold
    world.golds.forEach(g => {
        if(!g.active) return;
        ctx.fillStyle = "#ffde59"; 
        ctx.shadowBlur = 20; ctx.shadowColor = "#ffde59";
        ctx.beginPath(); ctx.arc(g.x, g.y, g.r, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
    });

    // Planets (Vibrant Minimalism)
    world.planets.forEach(p => {
        // Основной цвет
        ctx.fillStyle = p.color;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
        
        // Мягкая тень для объема
        ctx.fillStyle = 'rgba(0,0,0,0.2)';
        ctx.beginPath(); ctx.arc(p.x + p.r*0.15, p.y + p.r*0.15, p.r, 0, Math.PI*2); ctx.fill();
        
        // Множитель
        ctx.fillStyle = "#fff"; ctx.font = "bold 500px Arial"; ctx.textAlign="center";
        ctx.fillText("x"+p.mult, p.x, p.y - p.r - 300);
    });

    ctx.restore();
}

function startFlight() {
    state = 'FLYING';
    const rad = rocket.aimAngle * Math.PI / 180;
    const speed = 90; // Еще быстрее
    rocket.vx = Math.cos(rad) * speed; 
    rocket.vy = Math.sin(rad) * speed;
    document.getElementById('betControl').classList.add('hide');
    document.getElementById('timer-center').style.opacity = 0;
}

function finishRound(type, mult) {
    if(state === 'END') return;
    state = 'END';
    const final = type === 'LOST' ? 0 : parseFloat(mult) + bonusMult;
    
    if(final > 0) balance += Math.floor(currentBet * final);
    history.unshift(final); 
    if(history.length > 5) history.pop();

    document.getElementById('res-mult').innerText = 'x' + final.toFixed(1);
    document.getElementById('result-screen').style.display = 'flex';
}

function updateHistoryUI() {
    document.getElementById('hist-list').innerHTML = history.map(h => 
        `<div class="h-chip">x${h.toFixed(1)}</div>`
    ).join('');
}

function resize() { 
    canvas.width = window.innerWidth; 
    canvas.height = window.innerHeight; 
}

window.onload = init;
</script>
</body>
</html>