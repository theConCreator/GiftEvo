<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Orbit Pro: Ultimate Legacy</title>
    <style>
        :root { 
            --primary: #00ff88; --bg: #050508; --surface: rgba(20, 20, 25, 0.9);
            --danger: #ff4444; --gold: #ffcc00; --text-dim: #88888e;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; margin: 0; padding: 0; }
        body { background: var(--bg); color: white; font-family: -apple-system, system-ui, sans-serif; overflow: hidden; height: 100vh; }
        
        canvas { position: absolute; inset: 0; z-index: 1; }

        /* UI HEADER */
        header {
            position: fixed; top: 0; left: 0; width: 100%; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 100; pointer-events: none;
        }
        .ui-card { pointer-events: auto; background: var(--surface); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; }
        
        .stat-group { padding: 8px 15px; display: flex; flex-direction: column; }
        .balance-label { color: var(--primary); font-weight: 800; font-size: 18px; }
        .bonus-label { color: var(--gold); font-size: 11px; font-weight: bold; }

        .history-list { display: flex; gap: 5px; flex-grow: 1; justify-content: center; margin: 0 15px; overflow: hidden; }
        .h-chip { padding: 4px 10px; border-radius: 6px; background: rgba(0,0,0,0.4); font-size: 11px; font-weight: 900; color: var(--primary); }

        /* BOTTOM CONTROLS */
        .controls {
            position: fixed; bottom: 0; left: 0; width: 100%; padding: 20px 20px 35px;
            z-index: 100; background: linear-gradient(to top, var(--bg) 80%, transparent);
            display: flex; flex-direction: column; gap: 12px; transition: 0.4s;
        }
        .controls.hidden { transform: translateY(120%); }

        .bet-panel { display: flex; align-items: center; gap: 15px; padding: 15px; }
        input[type="range"] { flex: 1; accent-color: var(--primary); }
        .bet-num { width: 60px; font-weight: 900; color: var(--primary); font-size: 18px; }

        .launch-btn { 
            background: var(--primary); color: black; border: none; padding: 18px; 
            border-radius: 15px; font-weight: 900; font-size: 18px; cursor: pointer;
            box-shadow: 0 8px 25px rgba(0,255,136,0.2);
        }
        .launch-btn:disabled { background: #333; color: #666; box-shadow: none; }

        .cam-btn { 
            background: var(--surface); color: white; border: 1px solid rgba(255,255,255,0.1);
            padding: 10px; border-radius: 10px; flex: 1; font-weight: 600; font-size: 12px;
        }
        .cam-btn.active { background: var(--primary); color: black; }

        /* MODALS */
        #timer-box { 
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); 
            text-align: center; pointer-events: none; z-index: 50; 
        }
        #countdown { font-size: 80px; font-weight: 900; line-height: 1; }

        #result-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(20px);
        }
        .res-mult { font-size: 100px; font-weight: 900; color: var(--primary); margin: 10px 0; }
    </style>
</head>
<body>

<header>
    <div class="ui-card stat-group">
        <div class="balance-label">$<span id="bank">1000</span></div>
        <div class="bonus-label" id="bonus-tag">BONUS x0.0</div>
    </div>
    <div class="history-list" id="historyBar"></div>
    <button class="ui-card cam-btn" id="camBtn" style="flex: none; width: 80px;">FOLLOW</button>
</header>

<div id="timer-box">
    <div style="font-size: 12px; font-weight: 800; color: var(--primary); letter-spacing: 2px;">NEXT ROUND</div>
    <div id="countdown">5.0</div>
</div>

<div class="controls" id="uiControls">
    <div class="ui-card bet-panel">
        <input type="range" id="betSlider" min="10" max="1000" step="10" value="100">
        <div class="bet-num" id="betVal">100</div>
    </div>
    <button class="launch-btn" id="launchBtn">IGNITION</button>
</div>

<div id="result-modal">
    <div style="opacity: 0.5; font-weight: 800; letter-spacing: 5px;">RESULT</div>
    <div class="res-mult" id="resMult">x0.0</div>
    <button class="launch-btn" onclick="location.reload()" style="padding: 12px 50px;">NEXT MISSION</button>
</div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById('game'), ctx = canvas.getContext('2d');

// --- Глобальные переменные ---
const WORLD_SIZE = 15000;
let gameState = 'IDLE', timer = 5.0, balance = 1000, currentBet = 100, bonus = 0;
let cam = { x: 0, y: 0, z: 0.05, targetZ: 0.05, mode: 'follow' };
let rocket = { x: 0, y: 0, vx: 0, vy: 0, angle: 0, aimAngle: 0, trail: [] };
let world = { planets: [], asteroids: [], hazards: [], stars: [], gold: [] };
let history = [1.2, 5.5, 0.0, 2.1];
let shake = { p: 0, x: 0, y: 0 };

function init() {
    resize();
    window.addEventListener('resize', resize);
    generateWorld();
    updateHistoryUI();

    document.getElementById('betSlider').oninput = (e) => {
        currentBet = e.target.value;
        document.getElementById('betVal').innerText = currentBet;
    };

    document.getElementById('launchBtn').onclick = () => {
        if(gameState === 'IDLE' && balance >= currentBet) {
            balance -= currentBet;
            document.getElementById('bank').innerText = balance;
            document.getElementById('launchBtn').disabled = true;
            document.getElementById('launchBtn').innerText = 'READY';
        }
    };

    document.getElementById('camBtn').onclick = () => {
        cam.mode = cam.mode === 'follow' ? 'world' : 'follow';
        document.getElementById('camBtn').innerText = cam.mode.toUpperCase();
        document.getElementById('camBtn').classList.toggle('active', cam.mode === 'world');
    };

    requestAnimationFrame(loop);
}

function generateWorld() {
    world.stars = Array.from({length: 500}, () => ({ x: Math.random()*60000-30000, y: Math.random()*60000-30000, s: Math.random()*2 }));
    const colors = ['#00FF88', '#00D4FF', '#FF007B', '#FFD600', '#9D00FF'];
    for(let i=0; i<5; i++) {
        world.planets.push({
            dist: 3000 + i*2200, ang: Math.random()*Math.PI*2, speed: 0.0003 + i*0.0001,
            r: 400 + Math.random()*400, color: colors[i], mult: (1.5 + i*4).toFixed(1)
        });
    }
    world.hazards.push({ x: 5000, y: -5000, r: 300, gravityR: 3000 });
    world.gold = Array.from({length: 30}, () => ({ x: Math.random()*20000-10000, y: Math.random()*20000-10000, active: true }));
    for(let i=0; i<20; i++) {
        world.asteroids.push({ x: Math.random()*24000-12000, y: Math.random()*24000-12000, r: 100 + Math.random()*150 });
    }
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

function update() {
    // Движение планет
    world.planets.forEach(p => {
        p.ang += p.speed;
        p.x = Math.cos(p.ang) * p.dist;
        p.y = Math.sin(p.ang) * p.dist;
    });

    if(gameState === 'IDLE') {
        timer -= 1/60;
        document.getElementById('countdown').innerText = Math.max(0, timer).toFixed(1);
        rocket.aimAngle = Math.sin(Date.now() * 0.003) * 65;
        rocket.angle = rocket.aimAngle;
        if(timer <= 0) startFlight();
    } else if(gameState === 'FLYING') {
        rocket.trail.push({x: rocket.x, y: rocket.y});
        if(rocket.trail.length > 40) rocket.trail.shift();

        let maxShake = 0;
        // Планеты
        world.planets.forEach(p => {
            const dx = p.x - rocket.x, dy = p.y - rocket.y, d = Math.hypot(dx, dy);
            if(d < p.r * 3) {
                rocket.vx += (dx/d) * 6; rocket.vy += (dy/d) * 6;
                maxShake = Math.max(maxShake, 10);
                if(d < p.r + 50) endRound('WIN', p.mult);
            }
        });
        // Опасности (Черная дыра)
        world.hazards.forEach(h => {
            const dx = h.x - rocket.x, dy = h.y - rocket.y, d = Math.hypot(dx, dy);
            if(d < h.gravityR) {
                rocket.vx += (dx/d) * 8; rocket.vy += (dy/d) * 8;
                maxShake = 15;
                if(d < h.r) endRound('LOST', 0);
            }
        });
        // Сбор золота
        world.gold.forEach(g => {
            if(g.active && Math.hypot(g.x-rocket.x, g.y-rocket.y) < 600) {
                g.active = false; bonus += 0.2;
                document.getElementById('bonus-tag').innerText = `BONUS x${bonus.toFixed(1)}`;
            }
        });
        // Астероиды
        world.asteroids.forEach(a => {
            if(Math.hypot(a.x-rocket.x, a.y-rocket.y) < a.r + 50) endRound('LOST', 0);
        });

        shake.p = maxShake;
        rocket.x += rocket.vx; rocket.y += rocket.vy;
        rocket.angle = Math.atan2(rocket.vy, rocket.vx) * 180 / Math.PI;

        if(Math.hypot(rocket.x, rocket.y) > WORLD_SIZE + 5000) endRound('LOST', 0);
    }

    // Камера
    if(cam.mode === 'follow') {
        cam.x += (rocket.x - cam.x) * 0.1;
        cam.y += (rocket.y - cam.y) * 0.1;
        cam.targetZ = 0.04 / (1 + Math.hypot(rocket.vx, rocket.vy) * 0.01);
    } else {
        cam.x *= 0.1; cam.y *= 0.1;
        cam.targetZ = Math.min(canvas.width, canvas.height) / (WORLD_SIZE * 2.5);
    }
    cam.z += (cam.targetZ - cam.z) * 0.05;
    shake.x = (Math.random()-0.5) * shake.p;
    shake.y = (Math.random()-0.5) * shake.p;
}

function draw() {
    ctx.fillStyle = '#050508';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.save();
    ctx.translate(canvas.width/2 + shake.x, canvas.height/2 + shake.y);
    ctx.scale(cam.z, cam.z);
    ctx.translate(-cam.x, -cam.y);

    // Звезды
    ctx.fillStyle = 'rgba(255,255,255,0.4)';
    world.stars.forEach(s => ctx.fillRect(s.x, s.y, s.s/cam.z, s.s/cam.z));

    // Траектория при старте
    if(gameState === 'IDLE') {
        const rad = rocket.aimAngle * Math.PI / 180;
        ctx.setLineDash([150, 150]); ctx.strokeStyle = 'rgba(0, 255, 136, 0.2)'; ctx.lineWidth = 100;
        ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(rad)*8000, Math.sin(rad)*8000); ctx.stroke();
        ctx.setLineDash([]);
    }

    // Хвост
    if(rocket.trail.length > 1) {
        ctx.strokeStyle = 'rgba(0, 255, 136, 0.3)'; ctx.lineWidth = 100; ctx.lineJoin = 'round';
        ctx.beginPath(); rocket.trail.forEach((t, i) => i === 0 ? ctx.moveTo(t.x, t.y) : ctx.lineTo(t.x, t.y));
        ctx.stroke();
    }

    // Объекты
    world.hazards.forEach(h => {
        ctx.fillStyle = '#0a001a'; ctx.beginPath(); ctx.arc(h.x, h.y, h.r, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = '#7000ff'; ctx.lineWidth = 30; ctx.stroke();
    });

    world.gold.forEach(g => {
        if(!g.active) return;
        ctx.fillStyle = '#ffcc00'; ctx.beginPath(); ctx.arc(g.x, g.y, 150, 0, Math.PI*2); ctx.fill();
    });

    world.asteroids.forEach(a => {
        ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(a.x, a.y, a.r, 0, Math.PI*2); ctx.fill();
    });

    world.planets.forEach(p => {
        ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'white'; ctx.font = 'bold 400px sans-serif'; ctx.textAlign = 'center';
        ctx.fillText('x'+p.mult, p.x, p.y - p.r - 300);
    });

    // РАКЕТА (Исправленный размер)
    ctx.save();
    ctx.translate(rocket.x, rocket.y);
    ctx.rotate((rocket.angle + 90) * Math.PI / 180);
    // Размер ракеты теперь завязан на константу, которая хорошо видна при текущем зуме
    const rW = 400, rH = 1000; 
    ctx.fillStyle = '#00ff88';
    ctx.beginPath(); ctx.moveTo(0, -rH/2); ctx.lineTo(rW/2, rH/2); ctx.lineTo(-rW/2, rH/2); ctx.closePath(); ctx.fill();
    if(gameState === 'FLYING') {
        ctx.fillStyle = '#ff3d00'; ctx.beginPath(); ctx.arc(0, rH/2, rW/2, 0, Math.PI*2); ctx.fill();
    }
    ctx.restore();

    ctx.restore();
}

function startFlight() {
    gameState = 'FLYING';
    const rad = rocket.aimAngle * Math.PI / 180;
    const speed = 100;
    rocket.vx = Math.cos(rad) * speed; rocket.vy = Math.sin(rad) * speed;
    document.getElementById('uiControls').classList.add('hidden');
    document.getElementById('timer-box').style.display = 'none';
}

function endRound(res, mult) {
    if(gameState === 'ENDED') return;
    gameState = 'ENDED';
    const final = res === 'WIN' ? parseFloat(mult) + bonus : 0;
    if(final > 0) balance += Math.floor(currentBet * final);
    document.getElementById('resMult').innerText = 'x' + final.toFixed(1);
    document.getElementById('result-modal').style.display = 'flex';
}

function updateHistoryUI() {
    document.getElementById('historyBar').innerHTML = history.map(h => `<div class="h-chip">x${h.toFixed(1)}</div>`).join('');
}

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}

window.onload = init;
</script>
</body>
</html>