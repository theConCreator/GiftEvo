<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Gravity Launch</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #050505;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        canvas {
            display: block;
            background-color: #000;
        }

        #ui {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid #444;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 300px;
            transition: opacity 0.3s;
        }

        .controls-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        input[type=range] {
            width: 150px;
        }

        button {
            padding: 10px;
            background: #27ae60;
            border: none;
            color: white;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #2ecc71;
        }

        button:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }

        #overlay {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            pointer-events: none;
        }

        .status-msg {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

    <div id="overlay">
        <div id="status" class="status-msg">Приготовьтесь к запуску</div>
        <div id="timer"></div>
    </div>

    <div id="ui">
        <div class="controls-group">
            <label>Угол:</label>
            <input type="range" id="angleInput" min="0" max="360" value="270">
            <span id="angleVal">270°</span>
        </div>
        <div class="controls-group">
            <label>Сила:</label>
            <input type="range" id="powerInput" min="1" max="100" value="50">
            <span id="powerVal">50</span>
        </div>
        <button id="launchBtn">ЗАПУСК</button>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
/**
 * НАСТРОЙКИ ИГРЫ
 */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const ui = document.getElementById('ui');
const launchBtn = document.getElementById('launchBtn');

const MAP_RADIUS = 2000; // Размер круглой карты
const MAX_FLIGHT_TIME = 8000; // Макс. время полета в мс
const GRAVITY_CONSTANT = 0.5; // Сила гравитации
const GRAVITY_FIELD_FACTOR = 1.25; // Радиус действия гравитации (125% от радиуса планеты)

let width, height;
let gameState = 'PREPARE'; // PREPARE, FLYING, END
let planets = [];
let rocket = {
    x: 0,
    y: 0,
    vx: 0,
    vy: 0,
    angle: 0,
    history: [] // Для отрисовки шлейфа
};

let camera = {
    zoom: 4,
    x: 0,
    y: 0,
    targetZoom: 4
};

let flightStartTime = 0;

/**
 * ИНИЦИАЛИЗАЦИЯ
 */
function init() {
    resize();
    createPlanets();
    resetRocket();
    window.addEventListener('resize', resize);
    animate();
}

function resize() {
    width = window.innerWidth;
    height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;
}

function createPlanets() {
    planets = [];
    const count = 3 + Math.floor(Math.random() * 4); // 3-6 планет
    
    for (let i = 0; i < count; i++) {
        const radius = 30 + Math.random() * 70;
        // Коэффициент выигрыша: чем меньше планета, тем выше награда
        const multiplier = (100 / radius).toFixed(1);
        
        planets.push({
            radius: radius,
            orbitRadius: 400 + (i * 250),
            orbitAngle: Math.random() * Math.PI * 2,
            orbitSpeed: (0.005 / (radius / 50)), // Маленькие вращаются быстрее
            color: `hsl(${Math.random() * 360}, 70%, 60%)`,
            multiplier: multiplier,
            x: 0,
            y: 0
        });
    }
}

function resetRocket() {
    rocket.x = 0;
    rocket.y = 0;
    rocket.vx = 0;
    rocket.vy = 0;
    rocket.history = [];
    gameState = 'PREPARE';
    camera.targetZoom = 4;
    ui.style.opacity = "1";
    launchBtn.disabled = false;
    document.getElementById('status').innerText = "Выберите параметры и запускайте";
}

/**
 * ЛОГИКА
 */
function update() {
    // Обновление позиций планет на орбитах
    planets.forEach(p => {
        p.orbitAngle += p.orbitSpeed;
        p.x = Math.cos(p.orbitAngle) * p.orbitRadius;
        p.y = Math.sin(p.orbitAngle) * p.orbitRadius;
    });

    if (gameState === 'FLYING') {
        const now = Date.now();
        const elapsed = now - flightStartTime;

        // 1. Применяем гравитацию
        planets.forEach(p => {
            const dx = p.x - rocket.x;
            const dy = p.y - rocket.y;
            const dist = Math.sqrt(dx*dx + dy*dy);

            // Гравитация действует только в пределах 125% от радиуса планеты
            if (dist < p.radius * GRAVITY_FIELD_FACTOR) {
                const force = (p.radius * GRAVITY_CONSTANT) / (dist * dist);
                rocket.vx += (dx / dist) * force * 10;
                rocket.vy += (dy / dist) * force * 10;
            }

            // Проверка столкновения (победа)
            if (dist < p.radius) {
                win(p.multiplier);
            }
        });

        // 2. Движение ракеты
        rocket.x += rocket.vx;
        rocket.y += rocket.vy;
        rocket.history.push({x: rocket.x, y: rocket.y});
        if (rocket.history.length > 50) rocket.history.shift();

        // 3. Условия проигрыша
        const distFromCenter = Math.sqrt(rocket.x**2 + rocket.y**2);
        if (distFromCenter > MAP_RADIUS) {
            lose("Вылетели за пределы карты!");
        } else if (elapsed > MAX_FLIGHT_TIME) {
            lose("Закончилось топливо (время выйти)!");
        }

        // 4. Камера следит за ракетой, но плавно отдаляется
        camera.x = rocket.x;
        camera.y = rocket.y;
        if (camera.targetZoom > 0.4) camera.targetZoom -= 0.01;
    } else {
        // В режиме ожидания камера в центре
        camera.x = 0;
        camera.y = 0;
    }

    // Плавное приближение камеры
    camera.zoom += (camera.targetZoom - camera.zoom) * 0.05;
}

function win(m) {
    gameState = 'END';
    document.getElementById('status').innerText = `ПОБЕДА! Множитель: x${m}`;
    setTimeout(resetRocket, 3000);
}

function lose(msg) {
    gameState = 'END';
    document.getElementById('status').innerText = `ПРОИГРЫШ: ${msg}`;
    setTimeout(resetRocket, 3000);
}

/**
 * ОТРИСОВКА
 */
function draw() {
    ctx.clearRect(0, 0, width, height);

    ctx.save();
    // Центрируем камеру
    ctx.translate(width / 2, height / 2);
    ctx.scale(camera.zoom, camera.zoom);
    ctx.translate(-camera.x, -camera.y);

    // Рисуем границу карты
    ctx.beginPath();
    ctx.arc(0, 0, MAP_RADIUS, 0, Math.PI * 2);
    ctx.strokeStyle = '#333';
    ctx.setLineDash([20, 15]);
    ctx.stroke();
    ctx.setLineDash([]);

    // Рисуем орбиты
    planets.forEach(p => {
        ctx.beginPath();
        ctx.arc(0, 0, p.orbitRadius, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(255,255,255,0.05)';
        ctx.stroke();
    });

    // Рисуем планеты
    planets.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
        ctx.fillStyle = p.color;
        ctx.fill();
        
        // Текст множителя
        ctx.save();
        ctx.scale(1/camera.zoom, 1/camera.zoom); // Текст не должен сильно зумиться
        ctx.fillStyle = "white";
        ctx.font = "12px Arial";
        ctx.textAlign = "center";
        ctx.fillText(`x${p.multiplier}`, p.x * camera.zoom, (p.y - p.radius - 10) * camera.zoom);
        ctx.restore();
    });

    // Рисуем шлейф ракеты
    if (rocket.history.length > 1) {
        ctx.beginPath();
        ctx.moveTo(rocket.history[0].x, rocket.history[0].y);
        for(let i=1; i<rocket.history.length; i++) {
            ctx.lineTo(rocket.history[i].x, rocket.history[i].y);
        }
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
        ctx.stroke();
    }

    // Рисуем ракету
    ctx.save();
    ctx.translate(rocket.x, rocket.y);
    if (gameState === 'FLYING') {
        ctx.rotate(Math.atan2(rocket.vy, rocket.vx) + Math.PI/2);
    } else {
        ctx.rotate((document.getElementById('angleInput').value * Math.PI / 180) + Math.PI/2);
    }
    
    ctx.beginPath();
    ctx.moveTo(0, -10);
    ctx.lineTo(7, 10);
    ctx.lineTo(-7, 10);
    ctx.closePath();
    ctx.fillStyle = '#fff';
    ctx.fill();
    ctx.restore();

    ctx.restore();
}

function animate() {
    update();
    draw();
    requestAnimationFrame(animate);
}

/**
 * УПРАВЛЕНИЕ
 */
launchBtn.addEventListener('click', () => {
    if (gameState !== 'PREPARE') return;

    const angle = document.getElementById('angleInput').value * Math.PI / 180;
    const power = document.getElementById('powerInput').value / 10;

    rocket.vx = Math.cos(angle) * power;
    rocket.vy = Math.sin(angle) * power;
    
    gameState = 'FLYING';
    flightStartTime = Date.now();
    ui.style.opacity = "0";
    launchBtn.disabled = true;
    document.getElementById('status').innerText = "Полет нормальный...";
});

// Живое обновление значений UI
document.getElementById('angleInput').addEventListener('input', (e) => {
    document.getElementById('angleVal').innerText = e.target.value + '°';
});
document.getElementById('powerInput').addEventListener('input', (e) => {
    document.getElementById('powerVal').innerText = e.target.value;
});

// Старт
init();

</script>
</body>
</html>