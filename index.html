<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Orbit Pro: Vibrant Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <style>
        :root { 
            --bg: #0a0a1a; 
            --accent: #00ffa3; 
            --gold: #ffde59;
            --panel: rgba(255, 255, 255, 0.08);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background: var(--bg); color: white; overflow: hidden; height: 100vh; }

        canvas { position: absolute; inset: 0; z-index: 1; }
        #rocket-node { position: absolute; width: 60px; height: 60px; z-index: 10; pointer-events: none; }

        /* HEADER UI - Фикс наслоения */
        #header { 
            position: absolute; top: 0; left: 0; width: 100%; 
            display: flex; justify-content: space-between; align-items: flex-start;
            padding: 15px 20px; z-index: 100; pointer-events: none;
        }
        .header-item { pointer-events: auto; background: var(--panel); backdrop-filter: blur(10px); border-radius: 12px; padding: 8px 15px; border: 1px solid rgba(255,255,255,0.1); }
        
        .bank-info { display: flex; flex-direction: column; gap: 2px; }
        .balance-val { color: var(--accent); font-weight: 900; font-size: 16px; }
        .bonus-val { color: var(--gold); font-size: 11px; font-weight: bold; }

        .history-list { display: flex; gap: 5px; max-width: 40vw; overflow: hidden; }
        .h-chip { padding: 4px 10px; border-radius: 6px; background: rgba(0,0,0,0.3); font-size: 12px; font-weight: bold; color: #fff; }

        .btn-cam { cursor: pointer; font-size: 11px; font-weight: 900; letter-spacing: 1px; transition: 0.2s; }
        .btn-cam.active { background: var(--accent); color: #000; }

        /* Центр экрана */
        #timer-center { position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); text-align: center; pointer-events: none; }
        #count-num { font-size: 120px; font-weight: 900; line-height: 1; filter: drop-shadow(0 0 20px var(--accent)); }

        /* Управление ставкой */
        .bottom-panel { 
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); 
            width: 340px; z-index: 100; transition: 0.5s cubic-bezier(0.17, 0.84, 0.44, 1); 
        }
        .bottom-panel.hide { opacity: 0; transform: translate(-50%, 100px); }
        .bet-card { background: #121225; padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); pointer-events: auto; }
        
        input { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 15px; border-radius: 12px; margin-bottom: 12px; text-align: center; font-size: 20px; font-weight: bold; outline: none; }
        .btn-main { width: 100%; background: var(--accent); color: #000; border: none; padding: 18px; border-radius: 12px; font-weight: 900; text-transform: uppercase; cursor: pointer; }

        /* Модалка результата */
        #result-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(15px); }
        .res-box { text-align: center; }
        .res-mult { font-size: 100px; font-weight: 900; color: var(--accent); margin: 10px 0; }
    </style>
</head>
<body>

<div id="rocket-node"></div>
<canvas id="gameCanvas"></canvas>

<div id="header">
    <div class="header-item bank-info">
        <div class="balance-val">$ <span id="bank-val">1000</span></div>
        <div class="bonus-val" id="bonus-tag">BONUS x0.0</div>
    </div>
    <div class="header-item history-list" id="hist-list"></div>
    <div class="header-item btn-cam" id="camToggle">FOLLOW</div>
</div>

<div id="timer-center">
    <div id="count-num">5.0</div>
</div>

<div class="bottom-panel" id="betControl">
    <div class="bet-card">
        <input type="number" id="betInput" value="100" step="10">
        <button class="btn-main" id="launchBtn">Start Mission</button>
    </div>
</div>

<div id="result-screen">
    <div class="res-box">
        <div style="letter-spacing: 5px; opacity: 0.5;">RESULT</div>
        <div class="res-mult" id="res-mult">x2.5</div>
        <button class="btn-main" onclick="location.reload()" style="padding: 10px 40px;">Next Round</button>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas'), ctx = canvas.getContext('2d');
const rocketNode = document.getElementById('rocket-node');

// НАСТРОЙКИ СИСТЕМЫ (Компактнее)
const SYSTEM_RADIUS = 30000;
let state = 'IDLE', timer = 5.0, balance = 1000, currentBet = 0, bonusMult = 0;
let cam = { x: 0, y: 0, z: 0.03, tz: 0.03, mode: 'follow' };
let rocket = { x: 0, y: 0, vx: 0, vy: 0, rot: 0, aimAngle: 0 };
let world = { planets: [], stars: [], golds: [] };
let history = [1.5, 8.2, 0.0, 2.1];

function init() {
    window.addEventListener('resize', resize); resize();
    generateWorld();
    updateHistoryUI();
    lottie.loadAnimation({ container: rocketNode, renderer: 'svg', loop: true, autoplay: true, path: 'rocket1.json' });

    document.getElementById('launchBtn').onclick = () => {
        if(state === 'IDLE') {
            currentBet = parseInt(document.getElementById('betInput').value);
            balance -= currentBet; document.getElementById('bank-val').innerText = balance;
            document.getElementById('launchBtn').disabled = true;
            document.getElementById('launchBtn').style.opacity = 0.5;
        }
    };

    document.getElementById('camToggle').onclick = () => {
        cam.mode = cam.mode === 'follow' ? 'world' : 'follow';
        document.getElementById('camToggle').classList.toggle('active');
    };

    requestAnimationFrame(loop);
}

function generateWorld() {
    world.stars = Array.from({length: 400}, () => ({ x: Math.random()*80000-40000, y: Math.random()*80000-40000, s: Math.random()*3 }));
    const colors = ['#FF5E5E', '#FFCC5C', '#96CEB4', '#D4A5A5', '#88D8B0', '#6C5B7B'];
    
    // ПЛАНЕТЫ: Больше и ближе
    for(let i=0; i<6; i++) {
        world.planets.push({
            dist: 6000 + i*4500, ang: Math.random()*Math.PI*2, speed: 0.0003 + i*0.0001,
            r: 1200 + Math.random()*1500, // Увеличили размер
            color: colors[i],
            mult: (1.5 + (i * 2.5)).toFixed(1),
            x: 0, y: 0
        });
    }
    world.golds = Array.from({length: 25}, () => ({ x: Math.random()*50000-25000, y: Math.random()*50000-25000, r: 200, active: true }));
}

function update() {
    world.planets.forEach(p => {
        p.ang += p.speed; p.x = Math.cos(p.ang)*p.dist; p.y = Math.sin(p.ang)*p.dist;
    });

    if(state === 'IDLE') {
        timer -= 1/60;
        document.getElementById('count-num').innerText = Math.max(0, timer).toFixed(1);
        // Плавное вращение (сканирование) перед стартом
        rocket.aimAngle = Math.sin(Date.now()*0.002) * 60; 
        rocket.rot = rocket.aimAngle;
        if(timer <= 0) startFlight();
    } else if(state === 'FLYING') {
        // Ускоренный полет + сильная гравитация
        world.planets.forEach(p => {
            const dx = p.x - rocket.x, dy = p.y - rocket.y, d = Math.hypot(dx, dy);
            if(d < p.r * 2.5) {
                rocket.vx += (dx/d)*6; rocket.vy += (dy/d)*6; // Тянет сильнее
                if(d < p.r + 100) finishRound('WIN', p.mult);
            }
        });

        world.golds.forEach(g => {
            if(g.active && Math.hypot(g.x-rocket.x, g.y-rocket.y) < 600) {
                g.active = false; bonusMult += 0.2;
                document.getElementById('bonus-tag').innerText = `BONUS x${bonusMult.toFixed(1)}`;
            }
        });

        rocket.x += rocket.vx; rocket.y += rocket.vy;
        rocket.rot = Math.atan2(rocket.vy, rocket.vx)*180/Math.PI;
        if(Math.hypot(rocket.x, rocket.y) > SYSTEM_RADIUS + 10000) finishRound('LOST', 0);
    }

    // ЛОГИКА КАМЕРЫ
    if(cam.mode === 'follow') {
        cam.x += (rocket.x - cam.x) * 0.1; cam.y += (rocket.y - cam.y) * 0.1;
        cam.tz = 0.035 / (1 + Math.hypot(rocket.vx, rocket.vy)*0.01);
    } else {
        // WORLD MODE: Вместить всё
        cam.x *= 0.8; cam.y *= 0.8;
        const screenMin = Math.min(canvas.width, canvas.height);
        cam.tz = screenMin / (SYSTEM_RADIUS * 2.5); // Автомасштаб
    }
    cam.z += (cam.tz - cam.z) * 0.05;

    // Lottie sync
    const sx = (rocket.x - cam.x)*cam.z + canvas.width/2;
    const sy = (rocket.y - cam.y)*cam.z + canvas.height/2;
    rocketNode.style.left = sx-30+'px'; rocketNode.style.top = sy-30+'px';
    rocketNode.style.transform = `scale(${cam.z*40})`;
    rocketNode.style.rotate = (rocket.rot + 45) + 'deg';
}

function draw() {
    ctx.fillStyle = '#0a0a1a'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.save();
    ctx.translate(canvas.width/2, canvas.height/2); ctx.scale(cam.z, cam.z); ctx.translate(-cam.x, -cam.y);

    // Stars
    ctx.fillStyle = "#fff";
    world.stars.forEach(s => ctx.fillRect(s.x, s.y, s.s/cam.z, s.s/cam.z));

    // Gold Asteroids
    world.golds.forEach(g => {
        if(!g.active) return;
        ctx.fillStyle = "#ffde59"; ctx.beginPath(); ctx.arc(g.x, g.y, g.r, 0, Math.PI*2); ctx.fill();
    });

    // Planets (Clean & Vibrant)
    world.planets.forEach(p => {
        ctx.fillStyle = p.color;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
        // Тень для объема
        ctx.fillStyle = 'rgba(0,0,0,0.15)';
        ctx.beginPath(); ctx.arc(p.x+p.r*0.2, p.y+p.r*0.2, p.r, 0, Math.PI*2); ctx.fill();
        
        ctx.fillStyle = "#fff"; ctx.font = "bold 500px Arial"; ctx.textAlign="center";
        ctx.fillText("x"+p.mult, p.x, p.y - p.r - 300);
    });

    ctx.restore();
}

function startFlight() {
    state = 'FLYING';
    const rad = rocket.aimAngle * Math.PI / 180;
    rocket.vx = Math.cos(rad) * 80; rocket.vy = Math.sin(rad) * 80;
    document.getElementById('betControl').classList.add('hide');
    document.getElementById('timer-center').style.opacity = 0;
}

function finishRound(type, m) {
    state = 'END';
    const res = type === 'LOST' ? 0 : parseFloat(m) + bonusMult;
    history.unshift(res); if(history.length > 5) history.pop();
    document.getElementById('res-mult').innerText = 'x' + res.toFixed(1);
    document.getElementById('result-screen').style.display = 'flex';
}

function updateHistoryUI() {
    document.getElementById('hist-list').innerHTML = history.map(h => `<div class="h-chip">x${h.toFixed(1)}</div>`).join('');
}

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.onload = init;
</script>
</body>
</html>