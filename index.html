<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Staircase Gamble: Evolution</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body {
            margin: 0; background: #05050a; color: white;
            font-family: 'Arial Black', sans-serif; overflow: hidden;
            display: flex; flex-direction: column; align-items: center;
        }
        #ui {
            position: absolute; top: 20px; z-index: 10;
            text-align: center; pointer-events: none; width: 100%;
        }
        .stats-container { display: flex; justify-content: center; gap: 20px; }
        .stats {
            font-size: 22px; background: rgba(0,0,0,0.8);
            padding: 10px 25px; border-radius: 15px;
            border: 2px solid #e94560; box-shadow: 0 0 15px #e94560;
        }
        .controls { margin-top: 15px; pointer-events: auto; }
        button {
            padding: 15px 30px; font-size: 18px; font-weight: bold;
            border: none; border-radius: 8px; color: white;
            cursor: pointer; transition: 0.2s; margin: 0 5px;
        }
        #dropBtn { background: #22e960; }
        #cashBtn { background: #ff9900; display: none; }
        button:disabled { background: #444 !important; opacity: 0.5; }
    </style>
</head>
<body>

<div id="ui">
    <div class="stats-container">
        <div class="stats">BEST: <span id="bestScore">x0.00</span></div>
        <div class="stats">CURRENT: <span id="multiplier">x0.00</span></div>
    </div>
    <div class="controls">
        <button id="dropBtn" onclick="startRound()">LAUNCH</button>
        <button id="cashBtn" onclick="cashOut()">CASH OUT!</button>
    </div>
</div>

<script>
const { Engine, Render, Runner, Bodies, Composite, Body, Events } = Matter;

const engine = Engine.create();
const world = engine.world;
const render = Render.create({
    element: document.body, engine: engine,
    options: { width: window.innerWidth, height: window.innerHeight, wireframes: false, background: '#05050a' }
});

Render.run(render);
Runner.run(Runner.create(), engine);

let cube = null, steps = [], isMoving = false, isCashOut = false;
let bestMult = localStorage.getItem('bestStairMult') || 0;
document.getElementById('bestScore').innerText = `x${parseFloat(bestMult).toFixed(2)}`;

function createStep(index) {
    const x = index * 105; 
    const y = index * 75;
    const multValue = (0.1 * Math.pow(1.1, index)).toFixed(2);
    
    let type = 'normal';
    let color = '#1a1a2e';
    let friction = 0.3;
    let bounciness = 0.1;

    if (index > 0) {
        if (index % 20 === 0) { type = 'jump'; color = '#f9d423'; bounciness = 1.2; }
        else if (index % 12 === 0) { type = 'ice'; color = '#00d2ff'; friction = 0.01; }
        else if (index % 7 === 0) { type = 'boost'; color = '#22e960'; }
    }

    const step = Bodies.rectangle(x, y, 130, 25, {
        isStatic: true, friction: friction, restitution: bounciness,
        render: { fillStyle: color, strokeStyle: '#fff', lineWidth: 1 },
        stepType: type, mult: multValue, stepIndex: index
    });

    Composite.add(world, step);
    steps.push(step);
}

for (let i = 0; i < 20; i++) createStep(i);

Events.on(render, 'afterRender', () => {
    const context = render.context;
    context.font = "bold 14px Arial";
    context.fillStyle = "#ffffff";
    context.textAlign = "center";
    steps.forEach(s => {
        const b = render.bounds;
        if (s.position.x > b.min.x - 100 && s.position.x < b.max.x + 100) {
            let label = `x${s.mult}`;
            if (s.stepType === 'boost') label = "BOOST " + label;
            if (s.stepType === 'jump') label = "JUMP " + label;
            context.fillText(label, s.position.x, s.position.y - 20);
        }
    });
});

function startRound() {
    if (isMoving) return;
    if (cube) Composite.remove(world, cube);
    
    isMoving = true; isCashOut = false;
    document.getElementById('dropBtn').disabled = true;
    document.getElementById('cashBtn').style.display = 'inline-block';

    // Спавн выше: y = -300 вместо -150
    cube = Bodies.rectangle(0, -400, 36, 36, {
        restitution: 0.25, friction: 0.2, density: 0.001,
        render: { fillStyle: '#e94560', strokeStyle: '#fff', lineWidth: 2 }
    });

    const fX = 0.05 + Math.random() * 0.06;
    const fY = 0.06 + Math.random() * 0.06;
    Body.applyForce(cube, cube.position, { x: fX, y: fY });
    Body.setAngularVelocity(cube, (Math.random() - 0.5) * 0.6);
    Composite.add(world, cube);
}

function cashOut() {
    if (!cube || isCashOut) return;
    isCashOut = true;
    document.getElementById('cashBtn').disabled = true;
    Body.setMass(cube, 100);
    cube.friction = 1.5;
    cube.render.fillStyle = "#ffffff";
}

Events.on(engine, 'afterUpdate', () => {
    if (!cube) return;

    // Динамическая прыгучесть от вращения
    if (!isCashOut) {
        const rotSpeed = Math.abs(cube.angularVelocity);
        cube.restitution = 0.2 + Math.min(0.6, rotSpeed * 0.8);
    }

    Render.lookAt(render, {
        min: { x: cube.position.x - 500, y: cube.position.y - 400 },
        max: { x: cube.position.x + 500, y: cube.position.y + 400 }
    });

    if (cube.position.x > steps[steps.length - 10].position.x) createStep(steps.length);

    const standingOn = steps.find(s => 
        Math.abs(cube.position.x - s.position.x) < 70 && 
        Math.abs(cube.position.y - (s.position.y - 30)) < 25
    );

    if (standingOn) {
        document.getElementById('multiplier').innerText = `x${parseFloat(standingOn.mult).toFixed(2)}`;
        
        // Логика спец-ступенек
        if (standingOn.stepType === 'boost' && cube.speed < 5 && !isCashOut) {
            Body.applyForce(cube, cube.position, { x: 0.005, y: 0.005 });
        }
    }

    if (cube.speed < 0.15 && cube.position.y > 0) {
        if (standingOn) {
            const finalMult = parseFloat(standingOn.mult);
            if (finalMult > bestMult) {
                bestMult = finalMult;
                localStorage.setItem('bestStairMult', bestMult);
                document.getElementById('bestScore').innerText = `x${bestMult.toFixed(2)}`;
            }
        }
        endRound();
    }
    
    if (cube.position.y > (cube.position.x * 0.7) + 600) {
        document.getElementById('multiplier').innerText = "LOST!";
        endRound();
    }
});

function endRound() {
    isMoving = false;
    document.getElementById('dropBtn').disabled = false;
    document.getElementById('cashBtn').style.display = 'none';
    document.getElementById('cashBtn').disabled = false;
}

window.addEventListener('resize', () => {
    render.canvas.width = window.innerWidth;
    render.canvas.height = window.innerHeight;
});
</script>
</body>
</html>