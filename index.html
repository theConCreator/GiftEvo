<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Orbit Pro: TWA Hazards</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <style>
        :root { 
            --primary: #00ff88; 
            --bg: #050508; 
            --surface: rgba(18, 18, 24, 0.9);
            --danger: #ff4444; 
            --gold: #ffcc00;
            --text-dim: #88888e;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; margin: 0; padding: 0; }
        body { background: var(--bg); color: white; font-family: -apple-system, system-ui, sans-serif; overflow: hidden; height: 100vh; }
        
        canvas { position: absolute; inset: 0; z-index: 1; }
        #rocket-layer { position: absolute; width: 70px; height: 70px; z-index: 10; pointer-events: none; }

        /* HEADER UI */
        header {
            position: fixed; top: 0; left: 0; width: 100%;
            padding: 20px; display: flex; justify-content: space-between; align-items: flex-start;
            z-index: 100; pointer-events: none;
        }
        .header-card { 
            pointer-events: auto; background: var(--surface); backdrop-filter: blur(15px); 
            padding: 10px 16px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.08); 
        }
        .balance-box { display: flex; flex-direction: column; }
        .balance-val { color: var(--primary); font-weight: 800; font-size: 18px; }
        .bonus-val { color: var(--gold); font-size: 11px; font-weight: bold; text-transform: uppercase; }

        .history-list { display: flex; gap: 6px; overflow: hidden; }
        .h-item { 
            padding: 6px 12px; border-radius: 10px; font-size: 12px; font-weight: 800; 
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05); 
        }

        /* BOTTOM UI */
        .controls-root {
            position: fixed; bottom: 0; left: 0; width: 100%;
            padding: 20px 20px 40px; z-index: 100;
            background: linear-gradient(to top, var(--bg) 70%, transparent);
            display: flex; flex-direction: column; gap: 12px;
            transition: 0.4s cubic-bezier(0.17, 0.84, 0.44, 1);
        }
        .controls-root.hidden { transform: translateY(100%); opacity: 0; }

        .bet-card { 
            background: var(--surface); padding: 15px; border-radius: 20px; 
            border: 1px solid rgba(255,255,255,0.08); display: flex; align-items: center; gap: 15px;
        }
        input[type="range"] { flex: 1; accent-color: var(--primary); }
        .bet-display { width: 70px; text-align: right; font-weight: 900; color: var(--primary); font-size: 18px; }

        .launch-btn { 
            background: var(--primary); color: black; border: none; padding: 20px; 
            border-radius: 20px; font-weight: 900; font-size: 18px; letter-spacing: 1px;
            cursor: pointer; box-shadow: 0 10px 30px rgba(0,255,136,0.2);
        }

        .secondary-btns { display: flex; gap: 10px; }
        .btn-small { 
            flex: 1; background: var(--surface); color: white; border: 1px solid rgba(255,255,255,0.1);
            padding: 12px; border-radius: 14px; font-weight: 600; font-size: 12px;
        }
        .btn-small.active { background: var(--primary); color: black; border-color: var(--primary); }

        /* MODALS */
        #modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(15px);
        }
        .result-title { font-size: 12px; font-weight: 800; color: var(--text-dim); letter-spacing: 4px; }
        .result-mult { font-size: 100px; font-weight: 900; color: var(--primary); margin: 10px 0; }
    </style>
</head>
<body>

<div id="rocket-layer"></div>
<canvas id="game"></canvas>

<header>
    <div class="header-card balance-box">
        <span class="balance-val">$ <span id="bank">1000</span></span>
        <span class="bonus-val" id="bonus-tag">Bonus x0.0</span>
    </div>
    <div class="history-list" id="historyBar"></div>
</header>

<div class="controls-root" id="uiControls">
    <div class="bet-card">
        <input type="range" id="betSlider" min="10" max="1000" value="100">
        <div class="bet-display" id="betVal">100</div>
    </div>
    <button class="launch-btn" id="btnLaunch">START MISSION</button>
    <div class="secondary-btns">
        <button class="btn-small" id="camModeBtn">VIEW: FOLLOW</button>
        <button class="btn-small" onclick="location.reload()">REFRESH</button>
    </div>
</div>

<div id="modal-overlay">
    <div class="result-title">MISSION OVER</div>
    <div class="result-mult" id="finalMult">x0.0</div>
    <button class="launch-btn" onclick="location.reload()" style="padding: 15px 50px;">CONTINUE</button>
</div>

<script>
const canvas = document.getElementById('game'), ctx = canvas.getContext('2d');
const rocketEl = document.getElementById('rocket-layer');

/** ГЕЙМПЛЕЙНЫЕ ПАРАМЕТРЫ **/
const WORLD_RADIUS = 12000;
let gameState = 'IDLE', camMode = 'FOLLOW';
let balance = 1000, currentBet = 100, bonus = 0;
let shake = { x: 0, y: 0, power: 0 };

let rocket = { x: 0, y: 0, vx: 0, vy: 0, angle: 0, aimAngle: 0, visible: true, trail: [] };
let world = { planets: [], asteroids: [], hazards: [], stars: [], gold: [], particles: [] };

function init() {
    resize();
    window.addEventListener('resize', resize);
    lottie.loadAnimation({ container: rocketEl, renderer: 'svg', loop: true, autoplay: true, path: 'rocket1.json' });
    
    generateWorld();
    setupInputs();
    requestAnimationFrame(loop);
}

function generateWorld() {
    // Звезды
    world.stars = Array.from({length: 400}, () => ({ x: Math.random()*40000-20000, y: Math.random()*40000-20000, s: Math.random()*2 }));
    
    // Планеты (Цветные круги)
    const colors = ['#00FF88', '#00D4FF', '#FF007B', '#FFCC00', '#9D00FF'];
    for(let i=0; i<5; i++) {
        world.planets.push({
            dist: 2500 + i*1800, ang: Math.random()*Math.PI*2, speed: 0.0004 + i*0.0001,
            r: 300 + Math.random()*300, color: colors[i], mult: (1.5 + i*3.5).toFixed(1)
        });
    }

    // Опасности
    world.hazards.push({ x: 4000, y: -4000, r: 250, gravityR: 2500, type: 'void' });
    
    // Золото
    world.gold = Array.from({length: 25}, () => ({ x: Math.random()*15000-7500, y: Math.random()*15000-7500, active: true }));

    // Астероиды
    for(let i=0; i<15; i++) {
        world.asteroids.push({
            x: Math.random()*20000-10000, y: Math.random()*20000-10000,
            r: 80 + Math.random()*100, rot: Math.random()*Math.PI*2
        });
    }
}

function setupInputs() {
    const slider = document.getElementById('betSlider');
    slider.oninput = () => {
        currentBet = slider.value;
        document.getElementById('betVal').innerText = currentBet;
    };

    document.getElementById('btnLaunch').onclick = () => {
        if(gameState === 'IDLE' && balance >= currentBet) {
            balance -= currentBet;
            document.getElementById('bank').innerText = balance;
            startFlight();
        }
    };

    document.getElementById('camModeBtn').onclick = (e) => {
        camMode = camMode === 'FOLLOW' ? 'WORLD' : 'FOLLOW';
        e.target.classList.toggle('active', camMode === 'WORLD');
        e.target.innerText = `VIEW: ${camMode}`;
        vibrate(20);
    };
}

/** КАМЕРА **/
let cam = { x: 0, y: 0, z: 1.5, targetZ: 1.5 };

function update() {
    // Движение планет
    world.planets.forEach(p => {
        p.ang += p.speed;
        p.x = Math.cos(p.ang) * p.dist;
        p.y = Math.sin(p.ang) * p.dist;
    });

    if(gameState === 'IDLE') {
        rocket.aimAngle = Math.sin(Date.now() * 0.003) * 70; // Плавное качание
        rocket.angle = rocket.aimAngle;
    } else if(gameState === 'FLYING') {
        rocket.trail.push({x: rocket.x, y: rocket.y});
        if(rocket.trail.length > 50) rocket.trail.shift();

        // Гравитация планет
        let maxShake = 0;
        world.planets.forEach(p => {
            const dx = p.x - rocket.x, dy = p.y - rocket.y, d = Math.hypot(dx, dy);
            if(d < p.r * 3) {
                rocket.vx += (dx/d) * 5; rocket.vy += (dy/d) * 5;
                maxShake = Math.max(maxShake, (1 - d/(p.r*3)) * 10);
                if(d < p.r) endRound('WIN', p.mult);
            }
        });

        // Черные дыры
        world.hazards.forEach(h => {
            const dx = h.x - rocket.x, dy = h.y - rocket.y, d = Math.hypot(dx, dy);
            if(d < h.gravityR) {
                rocket.vx += (dx/d) * 7; rocket.vy += (dy/d) * 7;
                maxShake = Math.max(maxShake, 15);
                if(d < h.r) endRound('LOST', 0, '#7000ff');
            }
        });

        // Золото
        world.gold.forEach(g => {
            if(g.active && Math.hypot(g.x-rocket.x, g.y-rocket.y) < 500) {
                g.active = false; bonus += 0.2;
                document.getElementById('bonus-tag').innerText = `Bonus x${bonus.toFixed(1)}`;
                vibrate(40);
            }
        });

        // Астероиды
        world.asteroids.forEach(a => {
            if(Math.hypot(a.x-rocket.x, a.y-rocket.y) < a.r + 50) endRound('LOST', 0, '#aaa');
        });

        shake.power = maxShake;
        rocket.x += rocket.vx; rocket.y += rocket.vy;
        rocket.angle = Math.atan2(rocket.vy, rocket.vx) * 180 / Math.PI;

        if(Math.hypot(rocket.x, rocket.y) > WORLD_RADIUS) endRound('LOST', 0);
    }

    // Логика камеры
    if(camMode === 'FOLLOW') {
        cam.x += (rocket.x - cam.x) * 0.1;
        cam.y += (rocket.y - cam.y) * 0.1;
        cam.targetZ = 0.5 / (1 + Math.hypot(rocket.vx, rocket.vy) * 0.01);
    } else {
        cam.x *= 0.1; cam.y *= 0.1;
        cam.targetZ = Math.min(canvas.width, canvas.height) / (WORLD_RADIUS * 2.2);
    }
    cam.z += (cam.targetZ - cam.z) * 0.05;

    // Синхронизация DOM ракеты
    shake.x = (Math.random()-0.5) * shake.power;
    shake.y = (Math.random()-0.5) * shake.power;
    const sx = (rocket.x - cam.x) * cam.z + canvas.width/2 + shake.x;
    const sy = (rocket.y - cam.y) * cam.z + canvas.height/2 + shake.y;
    rocketEl.style.left = sx-35+'px'; rocketEl.style.top = sy-35+'px';
    rocketEl.style.transform = `scale(${cam.z * 50})`;
    rocketEl.style.rotate = (rocket.angle + 45) + 'deg';
}

function draw() {
    ctx.fillStyle = '#050508'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.save();
    ctx.translate(canvas.width/2 + shake.x, canvas.height/2 + shake.y);
    ctx.scale(cam.z, cam.z);
    ctx.translate(-cam.x, -cam.y);

    // Звезды
    ctx.fillStyle = 'white';
    world.stars.forEach(s => ctx.fillRect(s.x, s.y, s.s/cam.z, s.s/cam.z));

    // Траектория при старте
    if(gameState === 'IDLE') {
        const rad = rocket.aimAngle * Math.PI / 180;
        ctx.setLineDash([100, 100]); ctx.strokeStyle = 'rgba(0, 255, 136, 0.3)'; ctx.lineWidth = 40;
        ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(rad)*5000, Math.sin(rad)*5000); ctx.stroke();
        ctx.setLineDash([]);
    }

    // Хвост ракеты
    if(rocket.trail.length > 1) {
        ctx.strokeStyle = 'rgba(0, 255, 136, 0.4)'; ctx.lineWidth = 20; ctx.beginPath();
        rocket.trail.forEach((t, i) => i===0 ? ctx.moveTo(t.x, t.y) : ctx.lineTo(t.x, t.y));
        ctx.stroke();
    }

    // Объекты
    world.hazards.forEach(h => {
        ctx.fillStyle = '#110022'; ctx.beginPath(); ctx.arc(h.x, h.y, h.r, 0, Math.PI*2); ctx.fill();
        ctx.strokeStyle = '#7000ff'; ctx.lineWidth = 20; ctx.stroke();
    });

    world.gold.forEach(g => {
        if(!g.active) return;
        ctx.fillStyle = '#ffcc00'; ctx.shadowBlur = 50; ctx.shadowColor = '#ffcc00';
        ctx.beginPath(); ctx.arc(g.x, g.y, 100, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
    });

    world.planets.forEach(p => {
        ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = 'white'; ctx.font = 'bold 250px sans-serif'; ctx.textAlign = 'center';
        ctx.fillText('x'+p.mult, p.x, p.y - p.r - 200);
    });

    ctx.restore();
}

function startFlight() {
    gameState = 'FLYING';
    const rad = rocket.aimAngle * Math.PI / 180;
    rocket.vx = Math.cos(rad) * 90; rocket.vy = Math.sin(rad) * 90;
    document.getElementById('uiControls').classList.add('hidden');
    vibrate([50, 30, 50]);
}

function endRound(res, mult, color) {
    if(gameState === 'ENDED') return;
    gameState = 'ENDED';
    const final = res === 'WIN' ? parseFloat(mult) + bonus : 0;
    if(final > 0) balance += Math.floor(currentBet * final);
    
    document.getElementById('finalMult').innerText = 'x' + final.toFixed(1);
    if(color) document.getElementById('finalMult').style.color = color;
    document.getElementById('modal-overlay').style.display = 'flex';
    vibrate(200);
}

function vibrate(ms) { if(navigator.vibrate) navigator.vibrate(ms); }
function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
function loop() { update(); draw(); requestAnimationFrame(loop); }

window.onload = init;
</script>
</body>
</html>