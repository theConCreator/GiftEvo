<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Balloon Arena — FIXED BUILD</title>
<style>
html,body{margin:0;padding:0;overflow:hidden;height:100%;background:#081423;font-family:Inter,system-ui}
#root{display:flex;height:100%;width:100%;}
.sidebar{width:300px;background:#0b1c33;color:#d8eaff;padding:16px;display:flex;flex-direction:column;gap:12px;box-shadow:0 0 20px #0006}
.btn{background:#153a6b;border:1px solid #1d4a8a;padding:10px;border-radius:8px;color:white;font-weight:600;cursor:pointer;text-align:center}
.btn:disabled{opacity:.45;cursor:not-allowed}
.panel{background:#0f2746;padding:12px;border-radius:10px;box-shadow:0 0 10px #0005}
#arena{flex:1;position:relative;background:#061224;border-left:2px solid #0005;overflow:hidden}
.balloon{position:absolute;border-radius:50%;display:flex;justify-content:center;align-items:center;color:white;font-weight:700;pointer-events:auto;touch-action:none;box-shadow:0 4px 15px #0007}
.wall{position:absolute;background:#244;}
.spike{position:absolute;background:#611;}
.hud{position:absolute;top:10px;left:10px;color:#fff;background:#0007;padding:6px 12px;border-radius:8px;font-size:14px}
</style>
</head>
<body>
<div id="root">
  <div class="sidebar">
    <div class="panel">Баланс: <b id="balance">1000</b></div>
    <div class="panel">Фаза: <b id="phase">Покупка</b></div>
    <div class="panel">Осталось слотов: <b id="slots">0</b></div>
    <button id="buy" class="btn">Купить слот (10)</button>
    <button id="startPlace" class="btn">Начать размещение</button>
    <button id="startRound" class="btn">Старт раунда</button>
  </div>
  <div id="arena">
    <div class="hud" id="hud">—</div>
  </div>
</div>
<script>
const A=document.getElementById("arena");
const balEl=document.getElementById("balance");
const slotsEl=document.getElementById("slots");
const phaseEl=document.getElementById("phase");
const hud=document.getElementById("hud");

let S={balance:1000,phase:"buy",slots:0,nextId:1,balloons:new Map(),walls:[],spikes:[],event:null,wind:{x:0,y:0},blackHole:false,bounceBoost:false,roundActive:false};

function setPhase(p){S.phase=p;phaseEl.textContent=p;}

function refresh(){balEl.textContent=S.balance;slotsEl.textContent=S.slots;}
refresh();

// ---- FIX: buttons enable/disable correctly ----
function updateButtons(){
  document.getElementById("buy").disabled = S.phase!="buy";
  document.getElementById("startPlace").disabled = S.phase!="buy";
  document.getElementById("startRound").disabled = S.phase!="place";
}
updateButtons();

// ---- BUY SLOT ----
document.getElementById("buy").onclick = ()=>{
  if(S.phase!="buy")return;
  if(S.balance<10)return;
  S.balance-=10;
  S.slots++;
  refresh();
};

// ---- START PLACE ----
document.getElementById("startPlace").onclick = ()=>{
  if(S.phase!="buy")return;
  setPhase("place");
  updateButtons();
};

// ---- START ROUND ----
document.getElementById("startRound").onclick = ()=>{
  if(S.phase!="place")return;
  startRound();
};

// ---- BALLOON CREATION (HOLD TO INFLATE) ----
let active=null;
A.addEventListener("pointerdown",e=>{
  if(S.phase!="place" || S.slots<=0) return;
  const r=A.getBoundingClientRect();
  const x=e.clientX-r.left, y=e.clientY-r.top;
  const id=S.nextId++;
  const el=document.createElement("div");
  el.className="balloon";
  el.style.left=(x-20)+"px";
  el.style.top=(y-20)+"px";
  el.style.width="40px";
  el.style.height="40px";
  el.style.background=`hsl(${Math.random()*360},80%,55%)`;
  A.appendChild(el);
  const obj={id,x,y,r:20,vx:0,vy:0,el,placing:true};
  S.balloons.set(id,obj);
  active=obj;
  S.slots--;
  refresh();
});

A.addEventListener("pointermove",e=>{
  if(!active)return;
  const r=A.getBoundingClientRect();
  const x=e.clientX-r.left, y=e.clientY-r.top;
  active.x=x; active.y=y;
});

A.addEventListener("pointerup",()=>{if(active){active.placing=false;active=null;}});

// ---- GRID WALLS & SPIKES ----
function genObstacles(){
  S.walls.forEach(w=>w.el.remove());
  S.spikes.forEach(s=>s.el.remove());
  S.walls=[];S.spikes=[];
  const W=A.clientWidth,H=A.clientHeight;
  const gx=5, gy=5;

  for(let i=0;i<gx;i++){
    for(let j=0;j<gy;j++){
      if(Math.random()<0.25){
        const vertical=Math.random()<0.5;
        const el=document.createElement("div");
        el.className="wall";
        if(vertical){
          el.style.left=(i*(W/gx))+'px';
          el.style.top=(j*(H/gy))+'px';
          el.style.width='4px';
          el.style.height=(H/gy)+'px';
          S.walls.push({x:i*(W/gx),y:j*(H/gy),w:4,h:(H/gy),vertical:true,el});
        }else{
          el.style.left=(i*(W/gx))+'px';
          el.style.top=(j*(H/gy))+'px';
          el.style.width=(W/gx)+'px';
          el.style.height='4px';
          S.walls.push({x:i*(W/gx),y:j*(H/gy),w:(W/gx),h:4,vertical:false,el});
        }
        A.appendChild(el);
      }
      if(Math.random()<0.15){
        const el=document.createElement("div");
        el.className="spike";
        el.style.left=(i*(W/gx)+20)+'px';
        el.style.top=(j*(H/gy)+20)+'px';
        el.style.width='20px';
        el.style.height='20px';
        S.spikes.push({x:i*(W/gx)+20,y:j*(H/gy)+20,w:20,h:20,el});
        A.appendChild(el);
      }
    }
  }
}

// ---- EVENTS ----
function pickEvent(){
  if(Math.random()>0.7){S.event=null;hud.textContent='Событие: нет';return;}
  const ev=["wind","blackhole","bounce"][Math.floor(Math.random()*3)];
  S.event=ev;
  if(ev=="wind"){
    S.wind.x=(Math.random()*20-10);
    S.wind.y=(Math.random()*20-10);
    hud.textContent=`Событие: ветер ${S.wind.x.toFixed(1)},${S.wind.y.toFixed(1)}`;
  } else if(ev=="blackhole"){
    S.blackHole=true;
    hud.textContent=`Событие: чёрная дыра`;
  } else {
    S.bounceBoost=true;
    hud.textContent=`Событие: супер-отскок`;
  }
}

// ---- ROUND ----
function startRound(){
  setPhase("round");
  updateButtons();
  S.roundActive=true;
  S.blackHole=false;
  S.bounceBoost=false;
  pickEvent();
  genObstacles();
}

// ---- PHYSICS ----
let last=performance.now();
function loop(t){
  const dt=Math.min(50,t-last)/1000;last=t;
  if(S.phase=="round"){ physics(dt); }
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

function physics(dt){
  const W=A.clientWidth,H=A.clientHeight;
  const arr=[...S.balloons.values()];

  arr.forEach(b=>{
    if(b.placing){b.r=Math.min(70,b.r+30*dt);}else{
      b.vx+=S.wind.x*dt;
      b.vy+=S.wind.y*dt;
      if(S.blackHole){
        const dx=W/2-b.x, dy=H/2-b.y;
        const d=Math.hypot(dx,dy)+1;
        const f=200/d;
        b.vx+=dx/d*f*dt;
        b.vy+=dy/d*f*dt;
      }
    }
  });

  // integrate
  arr.forEach(b=>{
    if(!b.placing){b.x+=b.vx*dt*60;b.y+=b.vy*dt*60;}
    b.el.style.left=(b.x-b.r)+"px";
    b.el.style.top=(b.y-b.r)+"px";
    b.el.style.width=b.r*2+"px";
    b.el.style.height=b.r*2+"px";
  });

  // collisions (balls)
  for(let i=0;i<arr.length;i++){
    for(let j=i+1;j<arr.length;j++){
      const A=arr[i],B=arr[j];
      const dx=B.x-A.x, dy=B.y-A.y;
      const d=Math.hypot(dx,dy);
      const min=A.r+B.r;
      if(d<min){
        const nx=dx/(d||1), ny=dy/(d||1);
        const overlap=min-d;
        A.x-=nx*overlap/2;A.y-=ny*overlap/2;
        B.x+=nx*overlap/2;B.y+=ny*overlap/2;
        const k=0.8*(S.bounceBoost?1.6:1);
        const dvx=B.vx-A.vx, dvy=B.vy-A.vy;
        const imp=(dvx*nx+dvy*ny)*k;
        A.vx+=imp*nx;A.vy+=imp*ny;
        B.vx-=imp*nx;B.vy-=imp*ny;
      }
    }
  }

  // walls
  arr.forEach(b=>{
    S.walls.forEach(w=>{
      if(b.x+b.r>w.x && b.x-b.r<w.x+w.w && b.y+b.r>w.y && b.y-b.r<w.y+w.h){
        if(w.vertical){ b.x=w.x-(b.r); b.vx*=-0.9; }
        else{ b.y=w.y-(b.r); b.vy*=-0.9; }
      }
    });
  });

  // spikes
  arr.forEach(b=>{
    S.spikes.forEach(s=>{
      if(b.x+b.r>s.x && b.x-b.r<s.x+s.w && b.y+b.r>s.y && b.y-b.r<s.y+s.h){
        b.el.remove();S.balloons.delete(b.id);
      }
    });
  });
}
</script>
</body>
</html>