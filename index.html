<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<title>Mountain Drop – Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<style>
html, body {
  margin:0; padding:0; width:100%; height:100%;
  background:#0a0f1a; overflow:hidden; font-family:Arial, sans-serif;
  color:white;
}

/* --- Layout --- */
#container {
  display:flex;
  flex-direction:column;
  width:100%; height:100%;
}

#gameWrapper {
  margin-top:10px;
  width:100%;
  display:flex;
  justify-content:center;
}

#gameCanvas {
  background:#06101f;
  border:3px solid #2f465f;
  border-radius:12px;
  width:90vmin;
  height:90vmin;
  image-rendering:pixelated;
}

#controls {
  margin-top:10px;
  padding:15px;
  width:100%;
  display:flex;
  justify-content:center;
  gap:20px;
}

button {
  padding:12px 28px;
  border-radius:10px;
  font-size:18px;
  border:none;
  cursor:pointer;
  background:#38b2ac;
  color:#002f34;
  font-weight:bold;
  transition:0.2s;
}
button:hover { background:#2aa19c; }

#info {
  margin-top:5px;
  text-align:center;
  font-size:16px;
  opacity:0.8;
}
</style>
</head>

<body>
<div id="container">

  <div id="gameWrapper">
    <canvas id="gameCanvas"></canvas>
  </div>

  <div id="controls">
    <button id="buyBtn">Купить шар</button>
    <button id="camModeBtn">Режим камеры: Авто</button>
  </div>
  <div id="info">
    <div>Раунд: <span id="roundState">Покупка шаров</span></div>
    <div>Осталось времени: <span id="roundTimer">8</span></div>
    <div>Очередь шаров: <span id="queueCount">0</span></div>
  </div>

</div>

<script>
/* ---------------------------------------------------
   CANVAS INIT
--------------------------------------------------- */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
resizeCanvas();

function resizeCanvas(){
  const size = Math.min(window.innerWidth*0.9, window.innerHeight*0.9);
  canvas.width = size;
  canvas.height = size;
}
window.onresize = resizeCanvas;

/* ---------------------------------------------------
   GAME CONSTANTS
--------------------------------------------------- */
const MAP_W = 5000;
const MAP_H = 5000;
const BALL_R = 14;
const GRAVITY = 1800;
const REST = 0.55;

/* ---------------------------------------------------
   GAME STATE
--------------------------------------------------- */
let terrain;
let objects = [];
let balls = [];
let queue = [];

let cam = {x:0,y:0, zoom:1, targetZoom:1, mode:"auto"};
let timePrev = performance.now();

/* ---------------------------------------------------
   ROUND FLOW
--------------------------------------------------- */
let phase = "buy";            // buy → run → reset
let phaseTimer = 8;           // 8 sec buy
const buyDuration = 8;
const runDuration = 15;

const buyBtn = document.getElementById("buyBtn");
const camBtn = document.getElementById("camModeBtn");

buyBtn.onclick = () => queue.push("player");
camBtn.onclick = toggleCamMode;

function toggleCamMode(){
  cam.mode = cam.mode === "auto" ? "free" : "auto";
  camBtn.textContent = "Режим камеры: " + (cam.mode==="auto"?"Авто":"Свободная");
}

function updateRoundFlow(dt){
  phaseTimer -= dt;

  document.getElementById("roundState").textContent =
    phase==="buy" ? "Покупка шаров" : "Гонка";

  document.getElementById("roundTimer").textContent =
    Math.max(0, phaseTimer|0);

  document.getElementById("queueCount").textContent = queue.length;

  if(phase === "buy" && phaseTimer <= 0){
    startRun();
  }
  if(phase === "run" && phaseTimer <= 0){
    startNewRound();
  }
}

function startRun(){
  phase = "run";
  phaseTimer = runDuration;
  spawnBalls();
}

function startNewRound(){
  phase = "buy";
  phaseTimer = buyDuration;
  queue = [];
  balls = [];
  generateTerrain();
  generateObjects();
}

/* ---------------------------------------------------
   TERRAIN GENERATION
--------------------------------------------------- */
function generateTerrain(){
  const pts=[];
  let y = 500;
  for(let x=0; x<=MAP_W; x+=80){
    const tilt = -Math.random()*250 - 180; // круче наклон
    y += tilt*0.02 + (Math.random()*40 - 20);
    y = Math.max(200, Math.min(MAP_H-200, y));
    pts.push({x,y});
  }

  terrain=pts;
}

function generateObjects(){
  objects=[];
  for(let i=0;i<10;i++){ // пилы
    objects.push({
      type:"saw",
      x: Math.random()*MAP_W*0.8 + 200,
      y: Math.random()*MAP_H*0.8 + 200,
      r:30
    });
  }

  for(let i=0;i<12;i++){ // батуты
    objects.push({
      type:"bumper",
      x: Math.random()*MAP_W*0.8 + 200,
      y: Math.random()*MAP_H*0.8 + 200,
      r:35
    });
  }

  for(let i=0;i<15;i++){ // столбы
    objects.push({
      type:"pillar",
      x: Math.random()*MAP_W*0.9 + 100,
      y: Math.random()*MAP_H*0.9 + 100,
      r:20
    });
  }
}

/* ---------------------------------------------------
   BALL SPAWNING (fan explosion)
--------------------------------------------------- */
function spawnBalls(){
  const cx = terrain[0].x + 50;
  const cy = terrain[0].y - 50;

  balls=[];
  const N = queue.length;

  for(let i=0;i<N;i++){
    const angle = (-Math.PI/4) + (i/(N-1))* (Math.PI/2);
    balls.push({
      x:cx, y:cy,
      vx: Math.cos(angle)*300,
      vy: Math.sin(angle)*300,
      alive:true
    });
  }

  queue=[];
}

/* ---------------------------------------------------
   PHYSICS
--------------------------------------------------- */
function stepPhysics(dt){
  for(const b of balls){
    if(!b.alive) continue;

    b.vy += GRAVITY*dt;
    b.x += b.vx*dt;
    b.y += b.vy*dt;

    collideTerrain(b);
    collideObjects(b);
  }
}

function collideTerrain(b){
  for(let i=0;i<terrain.length-1;i++){
    const A = terrain[i];
    const B = terrain[i+1];

    if(b.x < A.x || b.x > B.x) continue;

    const t=(b.x-A.x)/(B.x-A.x);
    const y=A.y+(B.y-A.y)*t;

    if(b.y > y - BALL_R){
      b.y = y - BALL_R;
      b.vy *= -REST;
      b.vx += (Math.random()-0.5)*40;
    }
  }
}

function collideObjects(b){
  for(const o of objects){
    const dx=b.x-o.x, dy=b.y-o.y;
    const d=Math.hypot(dx,dy);
    if(d < o.r + BALL_R){
      if(o.type==="saw"){
        b.alive=false;
      }
      else if(o.type==="bumper"){
        const nx=dx/d, ny=dy/d;
        b.vx += nx*700;
        b.vy += ny*700;
      }
      else if(o.type==="pillar"){
        const nx=dx/d, ny=dy/d;
        b.x = o.x + nx*(o.r + BALL_R);
        b.y = o.y + ny*(o.r + BALL_R);
        b.vx *= -0.4;
        b.vy *= -0.4;
      }
    }
  }
}

/* ---------------------------------------------------
   CAMERA
--------------------------------------------------- */
function updateCamera(dt){
  if(cam.mode==="auto"){
    const aliveBalls = balls.filter(b=>b.alive);
    if(aliveBalls.length){
      let lead = aliveBalls.reduce((a,b)=>b.x>a.x?b:a);
      const targetX = lead.x - canvas.width/2/cam.zoom;
      const targetY = lead.y - canvas.height/2/cam.zoom;
      cam.x += (targetX - cam.x)*dt*4;
      cam.y += (targetY - cam.y)*dt*4;

      const speed = Math.hypot(lead.vx,lead.vy);
      cam.targetZoom = 1 - Math.min(0.004*speed, 0.5);
    }
  }

  cam.zoom += (cam.targetZoom - cam.zoom)*dt*4;
}

/* ---------------------------------------------------
   RENDER
--------------------------------------------------- */
function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.save();
  ctx.scale(cam.zoom, cam.zoom);
  ctx.translate(-cam.x,-cam.y);

  // Terrain
  ctx.strokeStyle="#3fb3ff";
  ctx.lineWidth=6;
  ctx.beginPath();
  ctx.moveTo(terrain[0].x, terrain[0].y);
  for(let i=1;i<terrain.length;i++)
    ctx.lineTo(terrain[i].x, terrain[i].y);
  ctx.stroke();

  // Objects
  for(const o of objects){
    if(o.type==="saw"){
      ctx.fillStyle="#ff3466";
    } else if(o.type==="bumper"){
      ctx.fillStyle="#42ff75";
    } else {
      ctx.fillStyle="#777";
    }
    ctx.beginPath();
    ctx.arc(o.x, o.y, o.r, 0, Math.PI*2);
    ctx.fill();
  }

  // Balls
  ctx.fillStyle="#ffd044";
  for(const b of balls){
      if(!b.alive) continue;
      ctx.beginPath();
      ctx.arc(b.x, b.y, BALL_R, 0, Math.PI*2);
      ctx.fill();
  }

  ctx.restore();
}

/* ---------------------------------------------------
   MAIN LOOP
--------------------------------------------------- */
function loop(t){
  const dt=(t - timePrev)/1000;
  timePrev=t;

  updateRoundFlow(dt);
  stepPhysics(dt);
  updateCamera(dt);
  render();

  requestAnimationFrame(loop);
}

generateTerrain();
generateObjects();
requestAnimationFrame(loop);
</script>

</body>
</html>
