<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Balloon Arena</title>
<script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    background: linear-gradient(180deg, #0a0d16, #0f1320);
    overflow: hidden;
    font-family: "Inter", sans-serif;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
  }

  #ui {
    position: fixed;
    top: 16px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 16px;
    background: rgba(255,255,255,0.06);
    padding: 12px 22px;
    border-radius: 18px;
    backdrop-filter: blur(8px);
    color: #fff;
    z-index: 20;
    box-shadow: 0 4px 18px rgba(0,0,0,0.35);
  }

  #ui button {
    background: linear-gradient(135deg, #ff3d6e, #ff1550);
    border: none;
    padding: 10px 20px;
    font-size: 16px;
    border-radius: 14px;
    color: #fff;
    cursor: pointer;
    box-shadow: 0 2px 12px rgba(255,50,90,0.45);
    transition: 0.2s;
  }

  #ui button:active {
    transform: scale(0.95);
  }

  #log {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    max-height: 150px;
    overflow-y: auto;
    padding: 12px;
    color: #e0e6ff;
    font-size: 14px;
    background: rgba(0,0,0,0.35);
    backdrop-filter: blur(6px);
    z-index: 20;
  }
</style>
</head>
<body>
<div id="ui">
  <button id="claimBtn">Забрать</button>
  <span>Раунд: <span id="timer">40</span>s</span>
</div>
<div id="log"></div>

<script>
// CONFIG
const ROUND_DURATION = 40;
const BALLOON_MIN_RADIUS = 22;
const BALLOON_MAX_RADIUS = 140;
const BALLOON_GROW_SPEED = 0.45;
const WIND_MIN = -90;
const WIND_MAX = 90;

// Global refs
let W = window.innerWidth;
let H = window.innerHeight;
let game, scene;
let balloons = [];
let obstacles = [];
let roundTimer = ROUND_DURATION;
let timerInterval = null;
let pointerDown = false;
let currentBalloon = null;
let windForce = 0;

const logBox = document.getElementById("log");
const log = (t) => logBox.innerHTML += t + "<br>";

document.getElementById("claimBtn").onclick = () => {
  if (!currentBalloon) return;
  const x = (currentBalloon.radius / 30).toFixed(2);
  log("Забрал x" + x);
  scene.removeBalloon(currentBalloon);
  currentBalloon = null;
};

window.onload = () => {
  const config = {
    type: Phaser.AUTO,
    width: W,
    height: H,
    backgroundColor: 0x0a0f18,
    physics: {
      default: 'arcade',
      arcade: {
        debug: false,
      }
    },
    scene: { preload, create, update }
  };

  game = new Phaser.Game(config);
};

function preload() {}

function create() {
  scene = this;

  startRound();

  this.input.on("pointerdown", pointerDownHandler);
  this.input.on("pointermove", pointerMoveHandler);
  this.input.on("pointerup", () => { pointerDown = false; });
}

function startRound() {
  roundTimer = ROUND_DURATION;
  document.getElementById("timer").innerText = roundTimer;
  log("Новый раунд!");

  clearArena();
  generateObstacles();

  timerInterval = setInterval(() => {
    roundTimer--;
    document.getElementById("timer").innerText = roundTimer;

    if (roundTimer <= 0) {
      clearInterval(timerInterval);
      endRound();
    }
  }, 1000);
}

function endRound() {
  log("Раунд окончен.");
  balloons.forEach(b => {
    const x = (b.radius / 30).toFixed(2);
    log("Ваш x" + x);
    b.sprite.destroy();
  });

  balloons = [];
  currentBalloon = null;
  startRound();
}

function clearArena() {
  obstacles.forEach(o => o.destroy());
  obstacles = [];
  balloons.forEach(b => b.sprite.destroy());
  balloons = [];
}

function generateObstacles() {
  // Walls
  let topWall = createWall(W / 2, 20, W * 0.8, 24);
  let bottomWall = createWall(W / 2, H - 20, W * 0.8, 24);

  obstacles.push(topWall, bottomWall);

  // Spikes
  for (let i = 0; i < 5; i++) {
    let s = createSpike(
      Phaser.Math.Between(60, W - 60),
      Phaser.Math.Between(80, H - 80)
    );
    obstacles.push(s);
  }

  // Wind
  windForce = Phaser.Math.FloatBetween(WIND_MIN, WIND_MAX);
  log("Ветер: " + windForce.toFixed(1));
}

function createWall(x, y, w, h) {
  let rect = scene.add.rectangle(x, y, w, h, 0x202636);
  scene.physics.add.existing(rect, true);
  rect.isWall = true;
  return rect;
}

function createSpike(x, y) {
  let s = scene.add.triangle(x, y, 0, 40, 20, 0, 40, 40, 0xff3355);
  scene.physics.add.existing(s, true);
  s.isSpike = true;
  return s;
}

function pointerDownHandler(pointer) {
  pointerDown = true;
  currentBalloon = createBalloon(pointer.x, pointer.y);
  balloons.push(currentBalloon);
}

function pointerMoveHandler(pointer) {
  if (!pointerDown || !currentBalloon) return;
  if (currentBalloon.radius <= BALLOON_MIN_RADIUS + 2) {
    currentBalloon.sprite.x = pointer.x;
    currentBalloon.sprite.y = pointer.y;
  }
}

function createBalloon(x, y) {
  let c = scene.add.circle(x, y, BALLOON_MIN_RADIUS, 0x55aaff);
  scene.physics.add.existing(c);
  c.body.setCircle(BALLOON_MIN_RADIUS);
  c.body.setCollideWorldBounds(true);
  c.body.setBounce(0.85);

  obstacles.forEach(o => scene.physics.add.collider(c, o));

  return { sprite: c, radius: BALLOON_MIN_RADIUS };
}

function update() {
  balloons.forEach(b => {
    b.sprite.body.velocity.x += windForce * 0.015;
  });

  if (pointerDown && currentBalloon) inflateBalloon(currentBalloon);

  for (let i = 0; i < balloons.length; i++)
    for (let j = i + 1; j < balloons.length; j++)
      scene.physics.world.collide(balloons[i].sprite, balloons[j].sprite);
}

function inflateBalloon(b) {
  if (b.radius >= BALLOON_MAX_RADIUS) return explode(b);

  let newR = b.radius + BALLOON_GROW_SPEED;
  if (!canExpand(b, newR)) return;

  b.radius = newR;
  b.sprite.setRadius(newR);
  b.sprite.body.setCircle(newR);
  b.sprite.body.mass = newR / 12;

  if (Math.random() < (b.radius / 2600)) explode(b);
}

function canExpand(balloon, newR) {
  for (let o of obstacles) {
    let dx = balloon.sprite.x - o.x;
    let dy = balloon.sprite.y - o.y;
    let dist = Math.sqrt(dx*dx + dy*dy);

    if (o.isWall && dist < newR + 28) return false;
    if (o.isSpike && dist < newR + 35) return explode(balloon), false;
  }
  return true;
}

function explode(b) {
  let x = b.sprite.x, y = b.sprite.y;
  let particles = scene.add.particles();
  let emitter = particles.createEmitter({
    x, y,
    speed: {min: -220, max: 220},
    scale: { start: 0.5, end: 0 },
    lifespan: 700,
    tint: 0xff3355
  });

  setTimeout(() => particles.destroy(), 700);

  log("Шар лопнул! x" + (b.radius / 30).toFixed(2));
  scene.removeBalloon(b);
}

Phaser.Scene.prototype.removeBalloon = function(b) {
  let idx = balloons.indexOf(b);
  if (idx >= 0) balloons.splice(idx, 1);
  b.sprite.destroy();
};
</script>
</body>
</html>