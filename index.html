<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Infinite Staircase Gamble</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body {
            margin: 0;
            background: #0f0c29;
            color: white;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #ui {
            position: absolute;
            top: 20px;
            z-index: 10;
            text-align: center;
            pointer-events: none;
        }
        .stats {
            font-size: 24px;
            background: rgba(0,0,0,0.6);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #00d2ff;
        }
        button {
            margin-top: 15px;
            padding: 10px 30px;
            font-size: 18px;
            background: #00d2ff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            pointer-events: auto;
        }
        button:disabled { background: #555; }
        canvas { display: block; }
    </style>
</head>
<body>

<div id="ui">
    <div class="stats">
        Множитель: <span id="multiplier">x0.00</span><br>
        Ступенька: <span id="stepCount">0</span>
    </div>
    <button id="dropBtn" onclick="startRound()">ЗАПУСК</button>
</div>

<script>
const { Engine, Render, Runner, Bodies, Composite, Body, Events } = Matter;

const engine = Engine.create();
const world = engine.world;
const render = Render.create({
    element: document.body,
    engine: engine,
    options: {
        width: window.innerWidth,
        height: window.innerHeight,
        wireframes: false,
        background: '#0f0c29'
    }
});

Render.run(render);
const runner = Runner.create();
Runner.run(runner, engine);

let cube = null;
let steps = [];
let lastStepY = 0;
let currentStepIndex = 0;
let isMoving = false;

// Генерация лестницы
function createStep(index) {
    const x = index * 80;
    const y = index * 60;
    const step = Bodies.rectangle(x, y, 100, 20, {
        isStatic: true,
        render: { fillStyle: '#3a445d' },
        label: 'step',
        stepIndex: index
    });
    // Текст с множителем на ступеньке
    step.mult = (0.1 * Math.pow(1.1, index)).toFixed(2);
    Composite.add(world, step);
    steps.push(step);
    return step;
}

// Начальная лестница
for (let i = 0; i < 20; i++) {
    createStep(i);
}

function startRound() {
    if (isMoving) return;
    
    // Очистка старого куба
    if (cube) Composite.remove(world, cube);
    
    document.getElementById('dropBtn').disabled = true;
    isMoving = true;

    // Создаем куб в начале
    cube = Bodies.rectangle(0, -100, 30, 30, {
        restitution: 0.3,
        friction: 0.1,
        render: { fillStyle: '#ff0055', strokeStyle: '#fff', lineWidth: 2 }
    });

    // Случайная сила вниз и вправо
    const forceX = 0.01 + Math.random() * 0.02;
    const forceY = 0.01 + Math.random() * 0.02;
    Body.applyForce(cube, cube.position, { x: forceX, y: forceY });
    Body.setAngularVelocity(cube, Math.random() * 0.2);

    Composite.add(world, cube);
}

// Слежение камеры и логика остановки
Events.on(engine, 'afterUpdate', () => {
    if (!cube) return;

    // Камера следует за кубом
    Render.lookAt(render, {
        min: { x: cube.position.x - 400, y: cube.position.y - 300 },
        max: { x: cube.position.x + 400, y: cube.position.y + 300 }
    });

    // Бесконечная генерация ступенек
    if (cube.position.x > steps[steps.length - 10].position.x) {
        createStep(steps.length);
    }

    // Определение текущей ступеньки и множителя
    const standingOn = steps.find(s => 
        Math.abs(cube.position.x - s.position.x) < 50 && 
        Math.abs(cube.position.y - (s.position.y - 25)) < 10
    );

    if (standingOn) {
        document.getElementById('multiplier').innerText = `x${standingOn.mult}`;
        document.getElementById('stepCount').innerText = standingOn.stepIndex;
    }

    // Проверка остановки (если скорость очень мала)
    if (cube.speed < 0.1 && cube.position.y > 0) {
        isMoving = false;
        document.getElementById('dropBtn').disabled = false;
    }
    
    // Если куб улетел в бездну мимо лестницы
    if (cube.position.y > (cube.position.x * 0.75) + 300) {
        isMoving = false;
        document.getElementById('dropBtn').disabled = false;
        document.getElementById('multiplier').innerText = "x0.00 (Мимо!)";
    }
});

window.addEventListener('resize', () => {
    render.canvas.width = window.innerWidth;
    render.canvas.height = window.innerHeight;
});
</script>
</body>
</html>