<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Orbit Pro: Compact Tension</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <style>
        :root { --accent: #00ffcc; --gold: #ffcc00; --bg: #050508; }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: white; overflow: hidden; }

        canvas { position: absolute; inset: 0; z-index: 1; }
        #rocket-node { position: absolute; width: 50px; height: 50px; z-index: 10; pointer-events: none; }

        /* HUD */
        #ui { position: absolute; inset: 0; z-index: 100; pointer-events: none; padding: 25px; }
        .interact { pointer-events: auto; }
        
        .top-left { position: absolute; top: 25px; left: 25px; display: flex; flex-direction: column; gap: 10px; }
        .stats { font-weight: 800; font-size: 14px; color: var(--accent); letter-spacing: 1px; }
        
        .history { position: absolute; top: 25px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; }
        .h-tag { padding: 4px 10px; background: rgba(255,255,255,0.05); border-radius: 4px; font-size: 11px; font-weight: bold; border: 1px solid rgba(255,255,255,0.1); }

        .cam-mode { position: absolute; top: 25px; right: 25px; background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .cam-mode.active { background: var(--accent); color: #000; }

        #timer-box { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        #count { font-size: 100px; font-weight: 900; line-height: 1; color: white; }

        /* Bet Panel */
        .controls { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); width: 320px; transition: 0.4s; }
        .controls.hide { opacity: 0; transform: translate(-50%, 40px); }
        .bet-wrap { background: #0c0c12; padding: 20px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        input { width: 100%; background: #000; border: 1px solid #222; color: #fff; padding: 12px; border-radius: 8px; margin-bottom: 12px; text-align: center; font-size: 18px; outline: none; }
        button { width: 100%; background: var(--accent); color: #000; border: none; padding: 16px; border-radius: 8px; font-weight: 800; text-transform: uppercase; cursor: pointer; }

        /* Finish Modal */
        #modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .m-content { text-align: center; }
        .m-mult { font-size: 80px; font-weight: 900; color: var(--accent); margin: 10px 0; }
    </style>
</head>
<body>

<div id="rocket-node"></div>
<canvas id="stage"></canvas>

<div id="ui">
    <div class="top-left">
        <div class="stats">CREDITS: <span id="bank">1000</span></div>
        <div id="bonus-val" style="color: var(--gold); font-size: 12px; font-weight: bold;">BONUS: +x0.0</div>
    </div>

    <div class="history" id="hist-bar"></div>
    <div class="cam-mode interact" id="camBtn">FOLLOW</div>

    <div id="timer-box">
        <div id="count">5.0</div>
    </div>

    <div class="controls" id="betControl">
        <div class="bet-wrap interact">
            <input type="number" id="betInp" value="100">
            <button id="goBtn">Deploy Rocket</button>
        </div>
    </div>
</div>

<div id="modal">
    <div class="m-content">
        <div style="font-size: 12px; letter-spacing: 4px; opacity: 0.4;">ROUND RESULT</div>
        <div class="m-mult" id="finalMult">x0.0</div>
        <button class="interact" onclick="location.reload()" style="padding: 10px 40px; width: auto;">Restart</button>
    </div>
</div>

<script>
const canvas = document.getElementById('stage'), ctx = canvas.getContext('2d');
const rocketNode = document.getElementById('rocket-node');

// Компактные настройки
const MAP_LIMIT = 50000; 
let state = 'WAIT', timer = 5.0, credits = 1000, bet = 0, bonus = 0;
let cam = { x: 0, y: 0, z: 0.02, tZ: 0.02, mode: 'follow', shake: 0 };
let rocket = { x: 0, y: 0, vx: 0, vy: 0, rot: 0, tRot: 0, trail: [] };
let world = { planets: [], stars: [], gold: [] };
let history = [1.2, 0.0, 3.5, 10.2];

function init() {
    window.onresize = resize; resize();
    setup();
    lottie.loadAnimation({ container: rocketNode, renderer: 'svg', loop: true, autoplay: true, path: 'rocket1.json' });
    
    document.getElementById('goBtn').onclick = () => {
        if(state === 'WAIT') {
            bet = parseInt(document.getElementById('betInp').value);
            credits -= bet; document.getElementById('bank').innerText = credits;
            document.getElementById('goBtn').disabled = true;
            document.getElementById('goBtn').innerText = "Standby...";
        }
    };

    document.getElementById('camBtn').onclick = () => {
        cam.mode = cam.mode === 'follow' ? 'world' : 'follow';
        document.getElementById('camBtn').classList.toggle('active');
    };

    renderHist();
    requestAnimationFrame(loop);
}

function setup() {
    world.stars = Array.from({length: 600}, () => ({ x: Math.random()*100000-50000, y: Math.random()*100000-50000, s: Math.random()*2 }));
    
    // Планеты (Плоские цвета для тестов)
    const colors = ['#ff4d4d', '#7d5fff', '#32ff7e', '#ff9f1a', '#18dcff', '#ff3838'];
    for(let i=0; i<6; i++) {
        const isSmall = Math.random() > 0.5;
        world.planets.push({
            d: 8000 + i*7000, a: Math.random()*Math.PI*2, s: 0.0002 + i*0.00005,
            r: isSmall ? 400 : 1400, color: colors[i],
            mult: isSmall ? (8 + Math.random()*20).toFixed(1) : (1.4 + Math.random()*2).toFixed(1),
            x: 0, y: 0
        });
    }

    world.gold = Array.from({length: 30}, () => ({ x: Math.random()*60000-30000, y: Math.random()*60000-30000, r: 150, active: true }));
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

function update() {
    world.planets.forEach(p => {
        p.a += p.s; p.x = Math.cos(p.a)*p.d; p.y = Math.sin(p.a)*p.d;
    });

    if(state === 'WAIT') {
        timer -= 1/60;
        document.getElementById('count').innerText = Math.max(0, timer).toFixed(1);
        rocket.rot += 4;
        if(timer <= 0) { state = 'SPIN'; timer = 3.5; rocket.tRot = Math.random()*360; }
    } else if(state === 'SPIN') {
        timer -= 1/60;
        document.getElementById('count').innerText = Math.max(0, timer).toFixed(1);
        document.getElementById('betControl').classList.add('hide');
        if(timer > 1.5) rocket.rot += 30;
        else rocket.rot += (rocket.tRot - (rocket.rot % 360)) * 0.1;
        
        if(timer <= 0) {
            state = 'FLY';
            rocket.vx = Math.cos(rocket.tRot*Math.PI/180)*65;
            rocket.vy = Math.sin(rocket.tRot*Math.PI/180)*65;
            document.getElementById('timer-box').style.opacity = 0;
        }
    } else if(state === 'FLY') {
        // Гравитация (сильнее для напряжения)
        world.planets.forEach(p => {
            const dx = p.x - rocket.x, dy = p.y - rocket.y, dist = Math.hypot(dx, dy);
            if(dist < p.r * 3) {
                rocket.vx += (dx/dist)*4.5; rocket.vy += (dy/dist)*4.5;
                if(dist < p.r + 500) cam.shake = 5; // Тряска при сближении
                if(dist < p.r + 80) finish('WIN', p.mult);
            }
        });

        // Сбор золота
        world.gold.forEach(g => {
            if(g.active && Math.hypot(g.x-rocket.x, g.y-rocket.y) < 500) {
                g.active = false; bonus += 0.2;
                document.getElementById('bonus-val').innerText = `BONUS: +x${bonus.toFixed(1)}`;
            }
        });

        rocket.x += rocket.vx; rocket.y += rocket.vy;
        rocket.rot = Math.atan2(rocket.vy, rocket.vx)*180/Math.PI;
        if(Math.hypot(rocket.x, rocket.y) > MAP_LIMIT) finish('LOST', 0);
    }

    // Камера
    if(cam.mode === 'follow') {
        cam.x += (rocket.x - cam.x) * 0.1; cam.y += (rocket.y - cam.y) * 0.1;
        let speed = Math.hypot(rocket.vx, rocket.vy);
        cam.tZ = 0.025 / (1 + speed*0.01);
    } else {
        cam.x *= 0.9; cam.y *= 0.9; cam.tZ = 0.007;
    }
    cam.z += (cam.tZ - cam.z) * 0.05;
    if(cam.shake > 0) cam.shake *= 0.9;

    const sx = (rocket.x - cam.x)*cam.z + canvas.width/2;
    const sy = (rocket.y - cam.y)*cam.z + canvas.height/2;
    rocketNode.style.left = sx-25+'px'; rocketNode.style.top = sy-25+'px';
    rocketNode.style.transform = `scale(${cam.z*40})`;
    rocketNode.style.rotate = (rocket.rot + 45) + 'deg';
}

function draw() {
    ctx.fillStyle = varColor('--bg'); ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.save();
    ctx.translate(canvas.width/2 + (Math.random()-0.5)*cam.shake, canvas.height/2 + (Math.random()-0.5)*cam.shake);
    ctx.scale(cam.z, cam.z);
    ctx.translate(-cam.x, -cam.y);

    // Звезды
    ctx.fillStyle = "#fff";
    world.stars.forEach(s => ctx.fillRect(s.x, s.y, s.s/cam.z*0.5, s.s/cam.z*0.5));

    // Золотые астероиды (Улучшенный вид)
    world.gold.forEach(g => {
        if(!g.active) return;
        let pulse = 1 + Math.sin(Date.now()*0.01)*0.2;
        ctx.shadowBlur = 15; ctx.shadowColor = "gold";
        ctx.fillStyle = "gold"; ctx.beginPath(); ctx.arc(g.x, g.y, g.r * pulse, 0, Math.PI*2); ctx.fill();
        ctx.shadowBlur = 0;
    });

    // Планеты (Flat)
    world.planets.forEach(p => {
        ctx.fillStyle = p.color;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = "#fff"; ctx.font = "bold 300px Arial"; ctx.textAlign="center";
        ctx.fillText("x"+p.mult, p.x, p.y - p.r - 200);
    });

    ctx.restore();
}

function finish(res, m) {
    state = 'END';
    const final = res === 'LOST' ? 0 : parseFloat(m) + bonus;
    document.getElementById('finalMult').innerText = 'x' + final.toFixed(1);
    document.getElementById('modal').style.display = 'flex';
}

function renderHist() {
    document.getElementById('hist-bar').innerHTML = history.map(h => `<div class="h-tag">x${h.toFixed(1)}</div>`).join('');
}

function varColor(name) { return getComputedStyle(document.documentElement).getPropertyValue(name); }
function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }

window.onload = init;
</script>
</body>
</html>