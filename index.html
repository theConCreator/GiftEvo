<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Orbit Pro: TWA Edition</title>
    <style>
        :root {
            --bg: #050505;
            --surface: #121214;
            --accent: #00ff88;
            --accent-glow: rgba(0, 255, 136, 0.3);
            --text-main: #ffffff;
            --text-dim: #88888e;
            --gold: #ffcc00;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { 
            background-color: var(--bg); 
            color: var(--text-main); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; height: 100vh; width: 100vw;
        }

        /* TWA Header */
        header {
            position: fixed; top: 0; left: 0; width: 100%;
            padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            z-index: 100;
        }

        .user-stats { display: flex; flex-direction: column; }
        .balance { font-size: 20px; font-weight: 800; color: var(--accent); }
        .bonus-tag { font-size: 10px; font-weight: bold; color: var(--gold); text-transform: uppercase; }

        .history-pills { display: flex; gap: 6px; }
        .pill { 
            background: rgba(255,255,255,0.08); padding: 4px 10px; border-radius: 8px; 
            font-size: 12px; font-weight: 700; border: 1px solid rgba(255,255,255,0.05);
        }

        /* Game Canvas */
        #stage { position: absolute; inset: 0; z-index: 1; }

        /* Bottom Controls */
        .controls-area {
            position: fixed; bottom: 0; left: 0; width: 100%;
            padding: 20px 20px 40px;
            background: linear-gradient(to top, var(--bg) 80%, transparent);
            z-index: 100;
            display: flex; flex-direction: column; gap: 15px;
        }

        .bet-input-row {
            display: flex; background: var(--surface); border-radius: 16px;
            padding: 8px; border: 1px solid rgba(255,255,255,0.05);
        }
        .bet-input-row input {
            background: transparent; border: none; color: white;
            width: 100%; text-align: center; font-size: 18px; font-weight: bold; outline: none;
        }

        .main-btn {
            background: var(--accent); color: black; border: none;
            padding: 20px; border-radius: 18px; font-size: 18px; font-weight: 800;
            text-transform: uppercase; letter-spacing: 1px; cursor: pointer;
            box-shadow: 0 4px 20px var(--accent-glow); transition: transform 0.1s;
        }
        .main-btn:active { transform: scale(0.96); }
        .main-btn:disabled { background: #333; color: #666; box-shadow: none; }

        .secondary-btns { display: flex; gap: 10px; }
        .icon-btn { 
            flex: 1; background: var(--surface); border: 1px solid rgba(255,255,255,0.1);
            color: white; padding: 12px; border-radius: 14px; font-weight: 600; font-size: 12px;
        }

        /* Overlays */
        #timer-overlay {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; pointer-events: none; z-index: 50;
        }
        #countdown { font-size: 80px; font-weight: 900; letter-spacing: -2px; opacity: 0.9; }

        #result-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; backdrop-filter: blur(10px);
        }
        .result-val { font-size: 120px; font-weight: 900; color: var(--accent); margin-bottom: 20px; }

    </style>
</head>
<body>

<header>
    <div class="user-stats">
        <div class="balance" id="balance-display">1000.00</div>
        <div class="bonus-tag" id="bonus-display">Bonus x0.0</div>
    </div>
    <div class="history-pills" id="history-bar"></div>
</header>

<canvas id="stage"></canvas>

<div id="timer-overlay">
    <div style="font-size: 12px; font-weight: 800; color: var(--accent); margin-bottom: 5px;">GET READY</div>
    <div id="countdown">5.0</div>
</div>

<div class="controls-area" id="controls">
    <div class="bet-input-row">
        <input type="number" id="bet-input" value="100" inputmode="numeric">
    </div>
    <button class="main-btn" id="launch-btn">Start Mission</button>
    <div class="secondary-btns">
        <button class="icon-btn" id="cam-toggle">VIEW: FOLLOW</button>
        <button class="icon-btn" onclick="location.reload()">REFRESH</button>
    </div>
</div>

<div id="result-modal">
    <div style="font-weight: bold; opacity: 0.5;">MISSION RESULT</div>
    <div class="result-val" id="result-mult">x0.0</div>
    <button class="main-btn" onclick="location.reload()" style="padding: 15px 60px;">Play Again</button>
</div>

<script>
    const canvas = document.getElementById('stage');
    const ctx = canvas.getContext('2d');

    // Параметры системы
    const SYSTEM_SIZE = 22000;
    let state = 'PREPARING', timer = 5.0, balance = 1000.00, currentBet = 0, bonus = 0;
    let cam = { x: 0, y: 0, z: 0.05, targetZ: 0.05, mode: 'follow' };
    let rocket = { x: 0, y: 0, vx: 0, vy: 0, rot: 0, aimAngle: 0 };
    let entities = { planets: [], stars: [], gold: [] };
    let history = [1.5, 2.4, 0.0, 12.1];

    function init() {
        resize();
        window.addEventListener('resize', resize);
        setupWorld();
        renderHistory();

        document.getElementById('launch-btn').onclick = () => {
            if (state === 'PREPARING') {
                let val = parseFloat(document.getElementById('bet-input').value);
                if (val <= balance) {
                    currentBet = val;
                    balance -= currentBet;
                    updateUI();
                    document.getElementById('launch-btn').disabled = true;
                    document.getElementById('launch-btn').innerText = 'Ready to launch';
                    vibrate(50);
                }
            }
        };

        document.getElementById('cam-toggle').onclick = (e) => {
            cam.mode = cam.mode === 'follow' ? 'world' : 'follow';
            e.target.innerText = `VIEW: ${cam.mode.toUpperCase()}`;
            vibrate(20);
        };

        requestAnimationFrame(loop);
    }

    function setupWorld() {
        // Звезды
        entities.stars = Array.from({length: 400}, () => ({
            x: Math.random() * 80000 - 40000,
            y: Math.random() * 80000 - 40000,
            s: Math.random() * 2 + 1
        }));

        // Планеты (Большие и яркие)
        const colors = ['#00F2FF', '#7000FF', '#FF007A', '#FFD600', '#00FF88'];
        for(let i=0; i<5; i++) {
            entities.planets.push({
                dist: 5500 + i*4200, 
                angle: Math.random() * Math.PI * 2,
                speed: 0.0004 + i*0.0001,
                r: 1000 + Math.random() * 1000,
                color: colors[i],
                mult: (1.5 + i*3).toFixed(1)
            });
        }

        // Золото
        entities.gold = Array.from({length: 25}, () => ({
            x: Math.random() * 40000 - 20000,
            y: Math.random() * 40000 - 20000,
            active: true
        }));
    }

    function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
    }

    function update() {
        entities.planets.forEach(p => {
            p.angle += p.speed;
            p.x = Math.cos(p.angle) * p.dist;
            p.y = Math.sin(p.angle) * p.dist;
        });

        if (state === 'PREPARING') {
            timer -= 1/60;
            document.getElementById('countdown').innerText = Math.max(0, timer).toFixed(1);
            rocket.aimAngle = Math.sin(Date.now() * 0.004) * 65; // Качание прицела
            rocket.rot = rocket.aimAngle;
            if (timer <= 0) startMission();
        } else if (state === 'MISSION') {
            // Гравитация
            entities.planets.forEach(p => {
                const dx = p.x - rocket.x, dy = p.y - rocket.y, d = Math.hypot(dx, dy);
                if (d < p.r * 2.5) {
                    rocket.vx += (dx/d) * 8; rocket.vy += (dy/d) * 8;
                    if (d < p.r + 50) endMission('WIN', p.mult);
                }
            });

            // Сбор бонусов
            entities.gold.forEach(g => {
                if (g.active && Math.hypot(g.x - rocket.x, g.y - rocket.y) < 600) {
                    g.active = false; bonus += 0.2;
                    document.getElementById('bonus-display').innerText = `Bonus x${bonus.toFixed(1)}`;
                    vibrate(30);
                }
            });

            rocket.x += rocket.vx; rocket.y += rocket.vy;
            rocket.rot = Math.atan2(rocket.vy, rocket.vx) * 180 / Math.PI;

            if (Math.hypot(rocket.x, rocket.y) > SYSTEM_SIZE + 5000) endMission('LOST', 0);
        }

        // Камера
        if (cam.mode === 'follow') {
            cam.x += (rocket.x - cam.x) * 0.1;
            cam.y += (rocket.y - cam.y) * 0.1;
            cam.targetZ = 0.04 / (1 + Math.hypot(rocket.vx, rocket.vy) * 0.01);
        } else {
            cam.x *= 0.1; cam.y *= 0.1;
            cam.targetZ = Math.min(canvas.width, canvas.height) / (SYSTEM_SIZE * 2.5);
        }
        cam.z += (cam.targetZ - cam.z) * 0.05;
    }

    function draw() {
        ctx.fillStyle = '#050505';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.save();
        ctx.translate(canvas.width/2, canvas.height/2);
        ctx.scale(cam.z, cam.z);
        ctx.translate(-cam.x, -cam.y);

        // Звезды
        ctx.fillStyle = 'rgba(255,255,255,0.4)';
        entities.stars.forEach(s => ctx.fillRect(s.x, s.y, s.s/cam.z, s.s/cam.z));

        // Траектория (Предсказание при старте)
        if (state === 'PREPARING') {
            const rad = rocket.aimAngle * Math.PI / 180;
            ctx.setLineDash([200, 200]);
            ctx.strokeStyle = 'rgba(0, 255, 136, 0.3)';
            ctx.lineWidth = 100;
            ctx.beginPath();
            ctx.moveTo(0,0);
            ctx.lineTo(Math.cos(rad)*8000, Math.sin(rad)*8000);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        // Золото
        entities.gold.forEach(g => {
            if (!g.active) return;
            ctx.fillStyle = '#ffd700';
            ctx.shadowBlur = 40; ctx.shadowColor = '#ffd700';
            ctx.beginPath(); ctx.arc(g.x, g.y, 250, 0, Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0;
        });

        // Планеты
        entities.planets.forEach(p => {
            ctx.fillStyle = p.color;
            ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill();
            
            // Стилизованный блик
            ctx.fillStyle = 'rgba(255,255,255,0.15)';
            ctx.beginPath(); ctx.arc(p.x - p.r*0.2, p.y - p.r*0.2, p.r*0.4, 0, Math.PI*2); ctx.fill();

            ctx.fillStyle = 'white'; ctx.font = 'bold 500px sans-serif'; ctx.textAlign = 'center';
            ctx.fillText('x' + p.mult, p.x, p.y - p.r - 400);
        });

        // РАКЕТА (SVG в коде)
        ctx.save();
        ctx.translate(rocket.x, rocket.y);
        ctx.rotate((rocket.rot + 90) * Math.PI / 180);
        const rSize = 800;
        ctx.fillStyle = '#00ff88';
        // Тело ракеты
        ctx.beginPath();
        ctx.moveTo(0, -rSize);
        ctx.lineTo(rSize/2, rSize);
        ctx.lineTo(-rSize/2, rSize);
        ctx.closePath();
        ctx.fill();
        // Огонь (если летит)
        if (state === 'MISSION') {
            ctx.fillStyle = '#ff3d00';
            ctx.beginPath(); ctx.arc(0, rSize, rSize/3 * (1 + Math.random()), 0, Math.PI*2); ctx.fill();
        }
        ctx.restore();

        ctx.restore();
    }

    function startMission() {
        state = 'MISSION';
        const rad = rocket.aimAngle * Math.PI / 180;
        const power = 100;
        rocket.vx = Math.cos(rad) * power;
        rocket.vy = Math.sin(rad) * power;
        document.getElementById('controls').classList.add('hidden');
        document.getElementById('timer-overlay').style.display = 'none';
        vibrate([50, 30, 50]);
    }

    function endMission(res, mult) {
        state = 'ENDED';
        const final = res === 'LOST' ? 0 : parseFloat(mult) + bonus;
        if(final > 0) balance += Math.floor(currentBet * final);
        
        history.unshift(final);
        if(history.length > 5) history.pop();
        
        document.getElementById('result-mult').innerText = 'x' + final.toFixed(1);
        document.getElementById('result-modal').style.display = 'flex';
        vibrate(200);
    }

    function updateUI() {
        document.getElementById('balance-display').innerText = balance.toFixed(2);
    }

    function renderHistory() {
        document.getElementById('history-bar').innerHTML = history.map(h => 
            `<div class="pill" style="color: ${h > 0 ? 'var(--accent)' : '#ff4444'}">x${h.toFixed(1)}</div>`
        ).join('');
    }

    function vibrate(ms) {
        if (navigator.vibrate) navigator.vibrate(ms);
    }

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }

    window.onload = init;

</script>
</body>
</html>